# 財經報告分析系統 - 概念驗證 (PoC) 與架構規劃

**文件日期**: 2025-09-11

## 1. 概念驗證 (PoC) 成果

### 1.1. 目標

驗證使用最新的 Gemini 模型，是否能從一份模擬的財經分析報告中，準確提取出結構化的交易策略資訊。

### 1.2. 使用的工具與參數

*   **模型**: `gemini-1.5-flash-latest`
*   **API 金鑰**: 由使用者提供 (`AIzaSy...`)
*   **模擬文件內容 (`poc_input.txt`)**:
    ```
    四月小作文-來頡6799
    日期：2025/4/4
    這是一份關於來頡(6799)的分析報告。我們認為該公司具有成長潛力，建議做多。進場點位可參考月線支撐，出場點可設定在前波高點。此策略建議短期操作，約一至兩週。
    ```
*   **專用提示詞 (`trading_strategy_poc_v2`)**:
    ```
    你是一位專業的量化交易策略分析師。你的任務是分析以下提供的文件內容（包含文字和圖片），並以嚴格的 JSON 格式回傳你的分析報告。JSON 物件必須包含以下所有欄位：

    1.  `product_symbol` (string): 從內容中識別出的主要金融商品代號（例如股票代號 '2330', 'TSLA' 或期貨合約 'TXF2'）。如果找不到，回傳 null。
    2.  `product_type` (string): 該商品的類型。可選值為 '股票' (Stock), '選擇權' (Options), '期貨' (Futures), '其他' (Other), '未知' (Unknown)。
    3.  `position` (string): 建議的倉位方向。可選值為 '做多' (Long), '做空' (Short), '中立' (Neutral)。
    4.  `strategy_summary` (string): 用 1-3 句話簡潔總結核心交易策略。
    5.  `entry_point` (string): 建議的進場點或進場條件。如果內容中未提及，回傳 null。
    6.  `exit_point` (string): 建議的出場點或停損/停利條件。如果內容中未提及，回傳 null。
    7.  `has_time_limit` (boolean): 此策略是否有明確的時間限制（例如 '僅限當日'、'一週內有效'）？
    8.  `document_date` (string): 根據內容（例如 LINE 的時間戳記、文件標題或內文）推斷出的這份分析的撰寫日期，格式為 YYYY-MM-DD。如果無法推斷，回傳 null。

    請直接回傳這個 JSON 物件，不要包含任何額外的解釋或 Markdown 標記。
    ```

### 1.3. PoC 執行結果 (AI 回應)

```json
{
  "product_symbol": "6799",
  "product_type": "股票",
  "position": "做多",
  "strategy_summary": "基於來頡(6799)的成長潛力，建議短期做多策略。進場點位參考月線支撐，出場點位設定在前波高點。",
  "entry_point": "月線支撐",
  "exit_point": "前波高點",
  "has_time_limit": true,
  "document_date": "2025-04-04"
}
```

### 1.4. 結論

**PoC 成功**。結果證明，使用一個設計良好的、專門的提示詞，配合最新的 AI 模型，可以非常準確地從非結構化的財經報告中提取出我們需要的結構化數據。這為我們開發全自動化的交易策略分析系統奠定了堅實的技術基礎。

---

## 2. 下一步架構規劃

基於 PoC 的成功，以及使用者對系統未來擴充性的期望，我們規劃採用一個**多階段、模組化的非同步處理管線 (Pipeline)** 架構。

### 2.1. 核心理念

將複雜的分析任務拆分成獨立、專注的步驟，每一步都由一個專門的後端模組負責。這樣可以提高系統的穩定性、可維護性和擴充性。

### 2.2. 後端模組化設計

將在 `src/tools/` 目錄下，新增或強化以下幾個核心模組：

1.  **文件解析器 (`document_parser.py`)**
    *   **職責**: 專門處理從各種來源（Google Drive, OneDrive, 網頁等）下載檔案並提取純文字與圖片。
    *   **技術選型**: 應使用現成的 Python 套件 (例如 `pydrive2`, `python-onedrive`) 來處理與特定雲端服務的互動，而非從頭打造。

2.  **金融數據擷取器 (`financial_data_fetcher.py`)**
    *   **職責**: 根據 AI 初步分析出的「股票代號」，從外部 API (如 Yahoo Finance) 獲取相關的金融數據（如歷史股價、成交量）。
    *   **技術選型**: 推薦使用 `yfinance` 套件。

3.  **策略合成器 (`strategy_synthesizer.py`)**
    *   **職責**: 執行最終、最複雜的 AI 分析。
    *   **運作方式**: 接收初步分析出的「策略摘要」，結合從外部抓取到的「量化數據」，然後使用一個更進階的提示詞，請求 Gemini 產出最終的綜合分析報告。

### 2.3. 建議的完整工作流程

1.  **觸發**: 使用者在前端提交一份或多份財經報告的網址。
2.  **階段一：內容提取與初步分析**
    *   `document_parser` 下載並提取內容。
    *   執行 `trading_strategy_poc_v2` 提示詞進行第一次 AI 分析，提取基本欄位。
    *   結果存入資料庫，狀態標記為 `analyzed`。
3.  **階段二：數據豐富化**
    *   `financial_data_fetcher` 根據股票代號，從 Yahoo Finance 抓取量化數據。
    *   數據存入資料庫，狀態更新為 `enriched`。
4.  **階段三：最終策略合成**
    *   `strategy_synthesizer` 將初步策略和量化數據整合，使用一個高階提示詞進行第二次、更深入的 AI 分析。
    *   最終報告存入資料庫，狀態更新為 `completed`。

這個架構將為我們打造一個強大、靈活且可擴充的自動化財經分析平台。
