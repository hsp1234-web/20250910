# 系統架構演進計畫 (V2) - MPA 架構

**文件建立時間**: `2025-09-09T18:49:25.219454+08:00`
**建立者**: Jules (AI 代理)
**狀態**: 初版草案 - 待使用者審核

---

## 1. 前言

本文件旨在記錄與使用者討論後，最終確定的系統架構演進方向。根據使用者的指示，我們將從目前的單體式前端 (SPA) 逐步過渡到一個更清晰、更易於維護的多頁應用程式 (MPA) 架構。

**核心原則**：保留現有穩定功能，並以新增獨立頁面的方式安全地擴充新功能。

---

## 2. 當前系統架構狀況分析

在本次規劃之前，系統的架構具有以下特點：

*   **架構模式**: 單頁應用程式 (Single-Page Application, SPA)。
*   **核心檔案**: `src/static/mp3.html`
    *   這個單一檔案承載了幾乎所有的前端功能，包括本機檔案轉錄、媒體下載器、YouTube 轉報告等。
    *   檔案內包含大量的 HTML、CSS 和內嵌的 JavaScript，導致其複雜度極高，難以維護和擴充。
*   **後端通訊**:
    *   後端 API (`src/api/api_server.py`) 提供 RESTful 端點和 WebSocket 服務。
    *   前端透過混合使用這兩種方式與後端通訊，但並行存在的輪詢 (`setInterval`) 和 WebSocket 更新機制已多次導致狀態不一致的錯誤。
*   **問題點**:
    *   **高耦合**: 所有功能都耦合在單一 HTML 檔案中，修改任一功能都可能影響到其他看似無關的部分。
    *   **維護困難**: 檔案體積龐大，邏輯混雜，新人或新代理難以快速上手。
    *   **擴充性差**: 新增一個主要功能就需要改動這個核心檔案，風險極高。使用者已明確指出，先前的拆分嘗試曾因「端點問題」而導致不好的結果。

### **當前架構圖 (簡化)**

```
+--------------------------------+
|       瀏覽器 (Browser)         |
+--------------------------------+
             |
             | (HTTP Request for /)
             v
+--------------------------------+
|     後端 (api_server.py)       |
|   - @app.get("/") -> mp3.html  |
+--------------------------------+
             |
             | (Returns mp3.html)
             v
+--------------------------------+
|      前端 (mp3.html)           |
|  - 包含所有功能的 HTML/JS      |
|  - (WebSocket + Polling)       |
+--------------------------------+
```

---

## 3. 建議的新架構：主頁-功能頁 (Hub-and-Spoke)

為了在不破壞現有穩定功能的基礎上實現擴充，我們將採用一個清晰的「主頁-功能頁」MPA 架構。

*   **主頁 (Hub)**: `main.html` 將作為所有功能的中心入口。它本身不包含複雜的功能邏輯，只負責導航。
*   **功能頁 (Spokes)**: 每個主要功能，無論是現有的還是未來的，都將是獨立的 HTML 頁面。例如 `mp3.html` 和未來新增的 `document_analyzer.html`。
*   **導覽流程**: 使用者首先訪問主頁，然後點擊按鈕跳轉到他們需要的功能頁。每個功能頁都會有一個「回到主頁」的按鈕，形成閉環操作。

### **新架構圖 (簡化)**

```
                     +--------------------------+
(HTTP Request for /) |   主頁 (main.html)       |
        +----------->| - 指揮中心標題           |
        |            | - [音訊轉錄儀] 按鈕    |
        |            | - [文件分析儀] 按鈕    |
        |            +--------------------------+
        |                  |            |
+------------------+       | (Link)     | (Link)
| 後端 API Server  |       v            v
| (api_server.py)  |  +----------+  +------------------------+
| - get("/")       |  | mp3.html |  | document_analyzer.html |
| - get("/static/*") |  | - [返回] |  | - [返回]               |
+------------------+  +----------+  +------------------------+
```

---

## 4. 具體實施計畫

根據與使用者的最終確認，我們將執行以下步驟來搭建新架構的基礎。

### **步驟一：建立新的主頁 (`main.html`)**

*   **動作**: 在 `src/static/` 目錄下，建立一個新的 `main.html` 檔案。
*   **檔案路徑**: `src/static/main.html`
*   **頁面內容**:
    *   一個主標題，例如「鳳凰指揮中心」。
    *   一個按鈕或超連結，文字為「**音訊轉錄儀**」，其 `href` 指向 `/static/mp3.html`。

### **步驟二：修改 `mp3.html` 以整合回主頁**

*   **動作**: 修改現有的 `mp3.html` 檔案，在頁面頂部新增一個返回按鈕。
*   **檔案路徑**: `src/static/mp3.html`
*   **具體修改**: 在 `<h1>音訊轉錄儀</h1>` 標題旁邊，新增一個 `<a>` 標籤或 `<button>`，文字為「**回到主頁**」，並將其連結到網站根目錄 (`/`)。

### **步驟三：更新伺服器路由**

*   **動作**: 修改 `api_server.py`，將根路由 (`/`) 的目標從 `mp3.html` 改為 `main.html`。
*   **檔案路徑**: `src/api/api_server.py`
*   **程式碼變更**:
    *   找到 `@app.get("/", response_class=HTMLResponse)` 裝飾的 `serve_frontend` 函式。
    *   將 `html_file_path = STATIC_DIR / "mp3.html"` 修改為 `html_file_path = STATIC_DIR / "main.html"`。

### **步驟四：未來擴充路徑**

當上述基礎架構完成後，未來新增 `plan2.md` 中描述的「文件分析儀」功能時，我們將遵循以下模式：

1.  在 `src/static/` 目錄下建立新的 `document_analyzer.html`。
2.  在 `src/api/api_server.py` 中為其建立專屬的後端 API 端點。
3.  在 `main.html` 中新增一個指向 `/static/document_analyzer.html` 的按鈕。

這個計畫旨在提供一個清晰、低風險且可持續擴充的開發路徑，完全符合使用者的最終要求。

---

## 5. 實施狀態 (Implementation Status)

**驗證時間**: 2025-09-09
**驗證者**: Jules (AI 代理)

**驗證結論**:
根據對 `src/static/main.html`, `src/static/mp3.html` 和 `src/api/api_server.py` 的程式碼審查，本計畫中描述的「主頁-功能頁」基礎導航架構已被確認**完全實作**。

*   **步驟一 (建立主頁)**: `main.html` 已存在且功能正確。
*   **步驟二 (修改 mp3.html)**: `mp3.html` 中已包含返回主頁的連結。
*   **步驟三 (更新路由)**: `api_server.py` 已將根路由 (`/`) 指向 `main.html`。

此基礎架構已生效，後續開發可基於此進行。

---

## 6. 下一階段開發計畫：文件分析儀 (Next Phase Development Plan: Document Analyzer)

**計畫制定時間**: 2025-09-09
**核心目標**: 開發一個完整的文件處理與分析流程，能夠從 Google Drive 下載文件，解析其內容（文字與圖片），透過 Gemini AI 進行分析，並最終生成一份圖文並茂的 PDF 報告。

### **功能模組詳解**

#### **核心工具模組 (預計存放於 `src/tools/`)**

這四個模組將是新系統的基石，各自負責一項獨立且明確的任務。

*   **`drive_downloader.py` - 智慧下載器**
    *   **功能**：提供 `download_file()` 函式，能夠智慧地處理來自 Google Drive 的分享連結，無論是直接的檔案連結 (`/file/...`) 還是 Google 文件 (`/document/...`)，都能準確地將其下載為 PDF 檔案。
    *   **如何使用**：`download_file(url, output_dir, file_name)`

*   **`pdf_parser.py` - PDF 解析器**
    *   **功能**：提供 `parse_pdf()` 函式，使用 `PyMuPDF` 套件來讀取一個 PDF 檔案，並從中分離出所有的**純文字內容**和**內嵌的圖片**。它會將圖片單獨存檔，並回傳文字和圖片路徑列表。
    *   **如何使用**：`parse_pdf(pdf_path, image_output_dir)`

*   **`report_generator.py` - 報告產生器 (包含字體解決方案)**
    *   **功能**：這是解決中文亂碼問題的核心。
        *   `setup_font()`: 一個「智慧字體安裝器」。它會自動從可靠的來源下載 `Noto Sans TC`（思源黑體）字體，並使用 `sudo` 權限將其安裝到系統中，確保 `weasyprint` 能找到它。
        *   `generate_pdf_report()`: 接收處理好的資料（文字、圖片），將其組合成 HTML，並呼叫 `weasyprint` 生成一份圖文並茂、**中文顯示完全正常**的 PDF 報告。
    *   **如何使用**：`setup_font()` (通常在流程開始時呼叫一次)，`generate_pdf_report(data, output_path)`

*   **`gemini_manager.py` - AI 核心管理器**
    *   **功能**：這是與 Google Gemini API 溝通的唯一窗口。
        *   它能管理您的 API 金鑰，並在未來支援多金鑰輪換和錯誤重試。
        *   `analyze_text()`: 接收純文字，呼叫 AI 進行摘要和關鍵字提取。
        *   `describe_image()`: 接收單張圖片，呼叫 AI 進行內容描述和圖表類型判斷。
    *   **如何使用**：先用您的 API 金鑰初始化 `GeminiManager` 類別，然後呼叫其下的方法。

#### **資料庫升級 (預計修改 `src/db/`)**

*   **`database.py`**：
    *   **新增資料表**：將新增 `documents` 和 `extracted_assets` 兩張表，用於未來結構化地儲存每個來源文件的處理狀態、雜湊值、原始文字、AI 摘要以及提取出的所有圖片和其對應的 AI 描述。
    *   **新增函式**：將加入 `add_document`, `check_document_exists_by_hash` 等一系列新函式來操作這些新表。
*   **`manager.py`**：
    *   需將所有上述的新資料庫函式，註冊到 `ACTION_MAP` 中，使其可以被系統的其他部分安全地呼叫。

#### **總指揮官 (預計存放於 `scripts/`)**

*   **`run_processing_pipeline.py`**：
    *   **功能**：此腳本將作為新功能的「總指揮官」，串聯上述所有模組，執行一個完整的端到端任務：從給定一個 URL 列表開始，到為每個文件產出 AI 分析結果為止。
    *   **如何執行**：`python scripts/run_processing_pipeline.py`
    *   **如何配置**：使用者只需在此腳本的頂部，將 `API_KEY` 變數替換為自己的金鑰即可。

這個計畫旨在建立一個模組化、可擴充的基礎架構，為未來加入更多 AI 分析功能或對接網頁前端打下堅實的基礎。
