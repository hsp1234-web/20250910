<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON 檢視器</title>
    <link rel="stylesheet" href="/static/css/nav.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #343a40;
        }
        .content {
            padding: 20px;
            max-width: 900px;
            margin: 20px auto;
        }
        #json-container {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .back-button {
            margin-bottom: 20px;
            display: inline-block;
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .back-button:hover {
            background-color: #5a6268;
        }
        h1 {
            color: #0056b3;
            margin-bottom: 20px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .copy-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.2s;
            font-weight: 500;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
        }
        .copy-button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .copy-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <ul>
            <li><a href="/">鳳凰主頁</a></li>
            <li><a href="/page1">網址提取</a></li>
            <li><a href="/page2">批次下載</a></li>
            <li><a href="/page3">檔案處理</a></li>
            <li><a href="/page4">AI 分析</a></li>
            <li><a href="/page5">備份管理</a></li>
            <li><a href="/page6">金鑰管理</a></li>
            <li><a href="/page7">提示詞管理</a></li>
        </ul>
    </nav>

    <div class="content">
        <h1>JSON 詳細資料</h1>
        <div class="controls">
            <a href="/page4" class="back-button">返回 AI 分析頁面</a>
            <button id="copy-json-button" class="copy-button">複製 JSON</button>
        </div>

        <pre id="json-container"><p>正在載入資料...</p></pre>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const jsonContainer = document.getElementById('json-container');
            const h1 = document.querySelector('h1');
            const copyJsonButton = document.getElementById('copy-json-button');
            let jsonContent = null; // 用於儲存 JSON 內容

            // 1. 從 URL 獲取 task_id
            const params = new URLSearchParams(window.location.search);
            const taskId = params.get('task_id');

            if (!taskId) {
                jsonContainer.textContent = '錯誤：URL 中缺少 task_id 參數。';
                h1.textContent = '載入失敗';
                copyJsonButton.disabled = true;
                return;
            }

            // 更新標題
            h1.textContent = `JSON 詳細資料 (任務 #${taskId})`;
            document.title = `JSON 檢視器 (任務 #${taskId})`;

            // 2. 從 API 獲取資料
            try {
                const response = await fetch(`/api/analyzer/stage1_result/${taskId}`);

                if (!response.ok) {
                    let errorMessage = `錯誤：無法獲取任務 #${taskId} 的資料 (狀態碼: ${response.status})。`;
                    try {
                        const errorData = await response.json();
                        errorMessage += `\n\n詳細資訊: ${errorData.error || JSON.stringify(errorData)}`;
                    } catch (e) {
                        // 如果回應不是 JSON 格式，則忽略
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                // 3. 格式化並顯示 JSON
                jsonContent = JSON.stringify(data, null, 2);
                jsonContainer.textContent = jsonContent;
                copyJsonButton.disabled = false;

            } catch (error) {
                console.error('獲取 JSON 資料時發生錯誤:', error);
                jsonContainer.textContent = `載入資料時發生錯誤。\n\n${error.message}`;
                copyJsonButton.disabled = true;
            }

            // 4. 複製按鈕邏輯
            copyJsonButton.addEventListener('click', () => {
                if (!jsonContent) return;

                navigator.clipboard.writeText(jsonContent).then(() => {
                    const originalText = copyJsonButton.innerText;
                    copyJsonButton.innerText = '已複製 ✅';
                    copyJsonButton.disabled = true;
                    setTimeout(() => {
                        copyJsonButton.innerText = originalText;
                        copyJsonButton.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('無法複製 JSON: ', err);
                    alert('複製失敗，您的瀏覽器可能不支援或未授予權限。');
                });
            });
        });
    </script>
</body>
</html>
