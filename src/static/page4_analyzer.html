<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é é¢å››ï¼šAI åˆ†æ</title>
    <link rel="stylesheet" href="/static/css/nav.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/page4.css">
</head>
<body>
    <nav class="top-nav">
        <ul>
            <li><a href="/">é³³å‡°ä¸»é </a></li>
            <li><a href="/page1">ç¶²å€æå–</a></li>
            <li><a href="/page2">æ‰¹æ¬¡ä¸‹è¼‰</a></li>
            <li><a href="/page3">æª”æ¡ˆè™•ç†</a></li>
            <li><a href="/page4" class="active">AI åˆ†æ</a></li>
            <li><a href="/page5">å‚™ä»½ç®¡ç†</a></li>
            <li><a href="/page6">é‡‘é‘°ç®¡ç†</a></li>
            <li><a href="/page7">æç¤ºè©ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="content">
        <!-- Panel 1: æª”æ¡ˆé¸æ“‡èˆ‡ç¬¬ä¸€éšæ®µåˆ†æ -->
        <div class="panel">
            <h1>AI åˆ†ææµç¨‹</h1>
            <p>è«‹å¾ä¸‹æ–¹åˆ—è¡¨ä¸­å‹¾é¸æ‚¨æƒ³åˆ†æçš„æª”æ¡ˆï¼Œé¸æ“‡æ¨¡å‹å¾Œå•Ÿå‹•ç¬¬ä¸€éšæ®µåˆ†æã€‚</p>
            <div class="management-links">
                <a href="/page6" class="button-link">ç®¡ç† API é‡‘é‘°</a>
                <a href="/page7" class="button-link">ç®¡ç†æç¤ºè©</a>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label for="stage1-model-select">é¸æ“‡ç¬¬ä¸€éšæ®µåˆ†ææ¨¡å‹:</label>
                <select id="stage1-model-select" disabled>
                    <option value="">è«‹å…ˆåœ¨ã€Œé‡‘é‘°ç®¡ç†ã€é é¢æ–°å¢æœ‰æ•ˆçš„ API é‡‘é‘°</option>
                </select>
            </div>

            <div style="margin-bottom: 10px; margin-top: 20px;">
                <button id="select-all-button">å…¨é¸</button>
                <button id="deselect-all-button">å–æ¶ˆå…¨é¸</button>
            </div>

            <div id="file-list-container">
                <p>æ­£åœ¨è¼‰å…¥å·²è™•ç†çš„æª”æ¡ˆ...</p>
            </div>

            <div style="margin-top: 20px;">
                <button id="start-stage1-btn">ğŸš€ é–‹å§‹ç¬¬ä¸€éšæ®µåˆ†æ</button>
            </div>
        </div>

        <!-- Panel 2: åˆ†æé€²åº¦å„€è¡¨æ¿ -->
        <div class="panel">
            <h2>åˆ†æé€²åº¦å„€è¡¨æ¿</h2>
            <p>æ­¤è™•æœƒé¡¯ç¤ºæ‰€æœ‰åˆ†æä»»å‹™çš„å³æ™‚ç‹€æ…‹ã€‚ç¬¬ä¸€éšæ®µå®Œæˆå¾Œï¼Œæ‚¨å¯å‹¾é¸æª”æ¡ˆä»¥é€²è¡Œç¬¬äºŒéšæ®µåˆ†æã€‚</p>

            <div class="form-group" style="margin-top: 20px;">
                <label for="stage2-model-select">é¸æ“‡ç¬¬äºŒéšæ®µåˆ†ææ¨¡å‹:</label>
                <select id="stage2-model-select" disabled>
                    <option value="">è«‹å…ˆåœ¨ã€Œé‡‘é‘°ç®¡ç†ã€é é¢æ–°å¢æœ‰æ•ˆçš„ API é‡‘é‘°</option>
                </select>
            </div>

            <div id="analysis-dashboard-container" style="margin-top: 10px;">
                <p>æ­£åœ¨ç­‰å¾…åˆ†æä»»å‹™...</p>
            </div>

            <div style="margin-top: 20px;">
                <button id="start-stage2-btn">ğŸ”¥ é–‹å§‹ç¬¬äºŒéšæ®µåˆ†æ</button>
            </div>
        </div>

        <!-- Panel 3: ç‹€æ…‹æ—¥èªŒ -->
        <div class="panel">
            <div class="panel-header">
                <h2>ç‹€æ…‹æ—¥èªŒ</h2>
                <button id="copy-log-button" class="copy-button" title="è¤‡è£½æ—¥èªŒ">è¤‡è£½</button>
            </div>
            <div id="status-area"></div>
        </div>
    </div>

    <!-- Modal for JSON/Error details -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title">è©³ç´°è³‡è¨Š</h3>
            <pre id="modal-body"></pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Cache ---
            const fileListContainer = document.getElementById('file-list-container');
            const dashboardContainer = document.getElementById('analysis-dashboard-container');
            const selectAllButton = document.getElementById('select-all-button');
            const deselectAllButton = document.getElementById('deselect-all-button');
            const startStage1Btn = document.getElementById('start-stage1-btn');
            const startStage2Btn = document.getElementById('start-stage2-btn');
            const statusArea = document.getElementById('status-area');
            const copyLogButton = document.getElementById('copy-log-button');
            const stage1ModelSelect = document.getElementById('stage1-model-select');
            const stage2ModelSelect = document.getElementById('stage2-model-select');
            // Modal is no longer used for JSON, but might be for other things. Keep it for now.
            const modal = document.getElementById('details-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeModal = document.querySelector('.close-button');

            // --- State ---
            let analysisTasks = [];

            // --- Utility Functions ---
            const formatTaipeiTime = (isoString) => {
                if (!isoString) return 'ç„¡æ•ˆæ™‚é–“';
                try {
                    return new Date(isoString).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false }).replace(/\//g, '-');
                } catch (e) { return 'æ™‚é–“æ ¼å¼éŒ¯èª¤'; }
            };

            const logStatus = (message, color = 'black') => {
                const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
                statusArea.insertAdjacentHTML('afterbegin', `<p style="color: ${color};">[${timestamp}] ${message}</p>`);
            };

            const translateStatus = (status) => {
                if (!status) return 'N/A';
                const statusMap = {
                    'pending': 'â³ ç­‰å¾…ä¸­',
                    'processing': 'ğŸ”„ è™•ç†ä¸­',
                    'completed': 'âœ… å®Œæˆ',
                    'failed': 'âŒ å¤±æ•—',
                    'processed': 'å¯ä¾›åˆ†æ',
                    'analyzed': 'åˆ†æå®Œæˆ'
                };
                return statusMap[status.toLowerCase()] || status;
            };

            // --- Core Render Functions ---
            const renderFileList = async () => {
                try {
                    const response = await fetch('/api/analyzer/processed_files');
                    if (!response.ok) throw new Error('ç„¡æ³•ç²å–å·²è™•ç†æª”æ¡ˆ');
                    const files = await response.json();
                    if (files.length === 0) {
                        fileListContainer.innerHTML = '<p>æ²’æœ‰å¯ä¾›åˆ†æçš„æª”æ¡ˆã€‚</p>';
                        return;
                    }
                    let html = `<table class="results-table"><thead><tr><th><input type="checkbox" id="select-all-header-checkbox"></th><th>æª”æ¡ˆåç¨±</th><th>ç‹€æ…‹</th></tr></thead><tbody>`;
                    files.forEach(file => {
                        const isSelectable = file.status === 'processed' || file.status === 'analyzed';
                        const checkbox = `<input type="checkbox" class="file-checkbox" value="${file.id}" ${isSelectable ? '' : 'disabled'}>`;
                        const statusMessage = isSelectable ? 'å¯é€²è¡Œåˆ†æ' : (file.status_message || 'ä¸é©ç”¨');
                        const statusClass = isSelectable ? 'status-completed' : 'status-error';

                        html += `<tr>
                                     <td>${checkbox}</td>
                                     <td title="${file.filename}">${file.filename}</td>
                                     <td class="${statusClass}" title="${statusMessage}">${translateStatus(file.status)}</td>
                                 </tr>`;
                    });
                    html += '</tbody></table>';
                    fileListContainer.innerHTML = html;
                } catch (error) {
                    fileListContainer.innerHTML = `<p style="color:red;">${error.message}</p>`;
                }
            };

            const renderAnalysisDashboard = () => {
                if (analysisTasks.length === 0) {
                    dashboardContainer.innerHTML = '<p>ç›®å‰æ²’æœ‰åˆ†æä»»å‹™ã€‚</p>';
                    return;
                }

                const getStatusHTML = (task, stage) => {
                    const status = stage === 1 ? task.stage1_status : task.stage2_status;
                    const errorLog = stage === 1 ? task.stage1_error_log : task.stage2_error_log;
                    const model = stage === 1 ? task.stage1_model : task.stage2_model_used;

                    const translatedStatus = translateStatus(status);
                    let statusClass = '';
                    if (status) {
                        if (status.includes('pending')) statusClass = 'status-pending';
                        else if (status.includes('processing')) statusClass = 'status-analyzing';
                        else if (status.includes('completed')) statusClass = 'status-analyzed';
                        else if (status.includes('failed')) statusClass = 'status-error';
                    }

                    let displayText = translatedStatus;
                    if (status === 'processing' && model) {
                        displayText = `${translatedStatus} (${model.replace('models/', '')})`
                    }

                    return `<span class="${statusClass}" title="${errorLog || ''}">${displayText}</span>`;
                };

                const getActionsHTML = (task) => {
                    let actions = [];
                    if (task.stage1_status === 'completed') {
                        actions.push(`<button class="action-btn btn-view" data-action="view-json" data-task-id="${task.id}">æª¢è¦–JSON</button>`);
                    }
                    if (task.stage2_status === 'completed' && task.stage2_report_path) {
                        const reportFilename = task.stage2_report_path.split(/[\\/]/).pop();
                        const reportUrl = `/reports/${reportFilename}`;
                        actions.push(`<a href="${reportUrl}" target="_blank" class="action-btn btn-report">æª¢è¦–å ±å‘Š</a>`);
                    }
                    if (task.stage1_status === 'failed') {
                        actions.push(`<button class="action-btn btn-log" data-action="view-log" data-task-id="${task.id}" data-stage="1">æ—¥èªŒ</button>`);
                        actions.push(`<button class="action-btn btn-retry" data-action="retry-stage1" data-task-id="${task.id}" data-file-id="${task.file_id}">é‡è©¦(1)</button>`);
                    }
                     if (task.stage2_status === 'failed') {
                        actions.push(`<button class="action-btn btn-log" data-action="view-log" data-task-id="${task.id}" data-stage="2">æ—¥èªŒ</button>`);
                        actions.push(`<button class="action-btn btn-retry" data-action="retry-stage2" data-task-id="${task.id}">é‡è©¦(2)</button>`);
                    }
                    return actions.join(' ');
                };

                let html = `<table class="results-table">
                    <thead><tr>
                        <th><input type="checkbox" id="dashboard-select-all"></th>
                        <th>æª”æ¡ˆåç¨±</th><th>ä½œè€…</th><th>æ¨¡å‹</th><th>Token æ¶ˆè€—</th><th>ç¬¬ä¸€éšæ®µç‹€æ…‹</th><th>ç¬¬äºŒéšæ®µç‹€æ…‹</th><th>æ“ä½œ</th>
                    </tr></thead><tbody>`;

                analysisTasks.forEach(task => {
                    const checkboxDisabled = task.stage1_status !== 'completed' || task.stage2_status === 'processing' || task.stage2_status === 'completed';
                    const detailUrl = task.file_hash ? `/static/page8_file_details.html?hash=${task.file_hash}` : '#';
                    const filenameLink = task.file_hash ? `<a href="${detailUrl}" title="${task.filename}">${task.filename}</a>` : `<span title="${task.filename}">${task.filename}</span>`;
                    const authorLink = task.author ? (task.file_hash ? `<a href="${detailUrl}" title="${task.author}">${task.author}</a>` : `<span title="${task.author}">${task.author}</span>`) : 'N/A';

                    const modelInfo = [task.stage1_model, task.stage2_model_used].filter(Boolean).map(m => m.replace('models/', '')).join('<br>');
                    const tokenUsage = (task.stage1_token_usage || 0) + (task.stage2_token_usage || 0);

                    html += `<tr id="task-row-${task.id}">
                        <td><input type="checkbox" class="dashboard-checkbox" value="${task.id}" ${checkboxDisabled ? 'disabled' : ''}></td>
                        <td>${filenameLink}</td>
                        <td>${authorLink}</td>
                        <td>${modelInfo || 'N/A'}</td>
                        <td>${tokenUsage > 0 ? tokenUsage.toLocaleString() : 'N/A'}</td>
                        <td>${getStatusHTML(task, 1)}</td>
                        <td>${getStatusHTML(task, 2)}</td>
                        <td>${getActionsHTML(task)}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                dashboardContainer.innerHTML = html;
            };

            // --- API Call Functions ---
            const fetchAnalysisStatus = async () => {
                try {
                    const response = await fetch('/api/analyzer/analysis_status');
                    if (!response.ok) throw new Error('ç„¡æ³•ç²å–åˆ†æç‹€æ…‹');
                    analysisTasks = await response.json();
                    renderAnalysisDashboard();
                } catch (error) {
                    logStatus(`ç²å–ç‹€æ…‹å¤±æ•—: ${error.message}`, 'red');
                }
            };

            const populateModelSelector = (selectorId, models) => {
                const selector = document.getElementById(selectorId);
                selector.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …
                const priorityOrder = ["models/gemini-2.0-flash-lite", "models/gemini-2.0-flash", "models/gemini-2.5-flash-lite", "models/gemini-2.5-flash"];
                const sortedModels = [...models].sort((a, b) => {
                    let aPriority = priorityOrder.indexOf(a);
                    let bPriority = priorityOrder.indexOf(b);
                    if (aPriority === -1) aPriority = priorityOrder.length + 1;
                    if (bPriority === -1) bPriority = priorityOrder.length + 1;
                    if (aPriority !== bPriority) return aPriority - bPriority;
                    return a.localeCompare(b);
                });
                sortedModels.forEach((modelName, index) => {
                    const option = document.createElement('option');
                    option.value = modelName;
                    option.textContent = modelName.replace('models/', '');
                    if (index === 0) option.selected = true;
                    selector.appendChild(option);
                });
            };

            const fetchAndRenderModels = async () => {
                try {
                    const response = await fetch('/api/keys/models');
                    if (!response.ok) throw new Error('ç„¡æ³•ç²å–æ¨¡å‹åˆ—è¡¨');
                    const models = await response.json();
                    populateModelSelector('stage1-model-select', models);
                    populateModelSelector('stage2-model-select', models);
                } catch (error) {
                    logStatus(`æ¨¡å‹è¼‰å…¥å¤±æ•—: ${error.message}`, 'red');
                }
            };

            const checkKeysAndLoadModels = async () => {
                try {
                    const response = await fetch('/api/keys');
                    const keys = await response.json();
                    const validKeys = keys.filter(k => k.is_valid);
                    if (validKeys.length > 0) {
                        stage1ModelSelect.disabled = false;
                        stage2ModelSelect.disabled = false;
                        await fetchAndRenderModels();
                    } else {
                        stage1ModelSelect.disabled = true;
                        stage2ModelSelect.disabled = true;
                        logStatus('åµæ¸¬åˆ°ç„¡æœ‰æ•ˆ API é‡‘é‘°ï¼Œæ¨¡å‹é¸å–®å·²ç¦ç”¨ã€‚', 'orange');
                    }
                } catch (error) {
                    logStatus(`æª¢æŸ¥ API é‡‘é‘°æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'red');
                    stage1ModelSelect.disabled = true;
                    stage2ModelSelect.disabled = true;
                }
            };

            // --- Event Listeners ---
            startStage1Btn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => parseInt(cb.value, 10));
                if (selectedIds.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æª”æ¡ˆã€‚');
                if (stage1ModelSelect.disabled) return alert('è«‹å…ˆæ–°å¢æœ‰æ•ˆçš„ API é‡‘é‘°æ‰èƒ½é–‹å§‹åˆ†æã€‚');
                const modelName = stage1ModelSelect.value;
                if (!modelName) return alert('è«‹é¸æ“‡ç¬¬ä¸€éšæ®µæ¨¡å‹ã€‚');

                logStatus(`å•Ÿå‹•ç¬¬ä¸€éšæ®µåˆ†æï¼Œå…± ${selectedIds.length} å€‹æª”æ¡ˆ...`, 'blue');
                try {
                    const response = await fetch('/api/analyzer/start_stage1_analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ file_ids: selectedIds, model_name: modelName })
                    });
                    if (response.ok) {
                        logStatus('åˆ†æè«‹æ±‚å·²æˆåŠŸç™¼é€ï¼Œæ­£åœ¨æ›´æ–°å„€è¡¨æ¿ç‹€æ…‹...', 'purple');
                        await fetchAnalysisStatus();
                    } else {
                        const errorData = await response.json().catch(() => ({ error: 'ç„¡æ³•è§£æä¼ºæœå™¨éŒ¯èª¤å›æ‡‰' }));
                        logStatus(`å•Ÿå‹•åˆ†æå¤±æ•—: ${errorData.error || response.statusText}`, 'red');
                    }
                } catch (error) {
                    logStatus(`å•Ÿå‹•åˆ†ææ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤: ${error.message}`, 'red');
                }
            });

            startStage2Btn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.dashboard-checkbox:checked')).map(cb => parseInt(cb.value, 10));
                if (selectedIds.length === 0) return alert('è«‹åœ¨å„€è¡¨æ¿ä¸­å‹¾é¸ç¬¬ä¸€éšæ®µå·²å®Œæˆçš„ä»»å‹™ã€‚');
                if (stage2ModelSelect.disabled) return alert('è«‹å…ˆæ–°å¢æœ‰æ•ˆçš„ API é‡‘é‘°æ‰èƒ½é–‹å§‹åˆ†æã€‚');
                const modelName = stage2ModelSelect.value;
                if (!modelName) return alert('è«‹é¸æ“‡ç¬¬äºŒéšæ®µæ¨¡å‹ã€‚');

                logStatus(`å•Ÿå‹•ç¬¬äºŒéšæ®µåˆ†æï¼Œå…± ${selectedIds.length} å€‹ä»»å‹™...`, 'blue');
                await fetch('/api/analyzer/start_stage2_analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ task_ids: selectedIds, model_name: modelName })
                });
            });

            dashboardContainer.addEventListener('click', async (e) => {
                const target = e.target.closest('.action-btn');
                if (!target) return;

                e.preventDefault();

                const action = target.dataset.action;
                const taskId = parseInt(target.dataset.taskId, 10);
                const task = analysisTasks.find(t => t.id === taskId);
                const currentRow = document.getElementById(`task-row-${taskId}`);
                if (!currentRow) return;

                const removeExistingDetailsRow = () => {
                    const existingDetails = document.querySelector('.details-row');
                    if(existingDetails) existingDetails.remove();
                };

                const createDetailsRow = (id, content) => {
                    const detailsRow = document.createElement('tr');
                    detailsRow.id = id;
                    detailsRow.classList.add('details-row');
                    detailsRow.innerHTML = `<td colspan="8" class="log-details"><pre>${content}</pre></td>`;
                    currentRow.after(detailsRow);
                    return detailsRow;
                }

                if (action === 'view-json') {
                    const detailsId = `json-details-${taskId}`;
                    const existingRow = document.getElementById(detailsId);
                    if (existingRow) return existingRow.remove();

                    removeExistingDetailsRow();
                    const placeholderRow = createDetailsRow(detailsId, 'ğŸ”„ æ­£åœ¨è¼‰å…¥ JSON è³‡æ–™...');

                    try {
                        const response = await fetch(`/api/analyzer/stage1_result/${taskId}`);
                        if (!response.ok) throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ (ç‹€æ…‹ ${response.status})`);
                        const data = await response.json();
                        placeholderRow.querySelector('pre').textContent = JSON.stringify(data, null, 2);
                    } catch (error) {
                        placeholderRow.querySelector('pre').textContent = `è¼‰å…¥ JSON å¤±æ•—: ${error.message}`;
                        placeholderRow.querySelector('td').style.color = 'red';
                    }
                } else if (action === 'view-log') {
                    const detailsId = `log-details-${taskId}`;
                    const existingRow = document.getElementById(detailsId);
                    if (existingRow) return existingRow.remove();

                    removeExistingDetailsRow();
                    const stage = target.dataset.stage;
                    const errorLog = (stage === '1' ? task.stage1_error_log : task.stage2_error_log) || 'æ²’æœ‰è©³ç´°çš„éŒ¯èª¤è³‡è¨Šã€‚';
                    createDetailsRow(detailsId, errorLog);

                } else if (action === 'retry-stage1') {
                    const fileId = parseInt(target.dataset.fileId, 10);
                    const modelName = stage1ModelSelect.value;
                    if (!modelName) return alert('è«‹é¸æ“‡ç¬¬ä¸€éšæ®µæ¨¡å‹ã€‚');
                    logStatus(`æ­£åœ¨ç‚ºæª”æ¡ˆ #${fileId} é‡è©¦ç¬¬ä¸€éšæ®µåˆ†æ...`, 'blue');
                    await fetch('/api/analyzer/start_stage1_analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ file_ids: [fileId], model_name: modelName })
                    });
                    await fetchAnalysisStatus();
                } else if (action === 'retry-stage2') {
                     const modelName = stage2ModelSelect.value;
                     if (!modelName) return alert('è«‹é¸æ“‡ç¬¬äºŒéšæ®µæ¨¡å‹ã€‚');
                     logStatus(`æ­£åœ¨ç‚ºä»»å‹™ #${taskId} é‡è©¦ç¬¬äºŒéšæ®µåˆ†æ...`, 'blue');
                     await fetch('/api/analyzer/start_stage2_analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ task_ids: [taskId], model_name: modelName })
                    });
                    await fetchAnalysisStatus();
                }
            });

            selectAllButton.addEventListener('click', () => document.querySelectorAll('.file-checkbox:not(:disabled)').forEach(cb => cb.checked = true));
            deselectAllButton.addEventListener('click', () => document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false));
            dashboardContainer.addEventListener('change', e => {
                if (e.target.id === 'dashboard-select-all') {
                    document.querySelectorAll('.dashboard-checkbox:not(:disabled)').forEach(cb => e.target.checked ? cb.checked = true : cb.checked = false);
                }
            });

            copyLogButton.addEventListener('click', () => {
                const logContent = statusArea.innerText;
                navigator.clipboard.writeText(logContent).then(() => {
                    const originalText = copyLogButton.innerText;
                    copyLogButton.innerText = 'å·²è¤‡è£½ âœ…';
                    copyLogButton.disabled = true;
                    setTimeout(() => {
                        copyLogButton.innerText = originalText;
                        copyLogButton.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('ç„¡æ³•è¤‡è£½æ—¥èªŒ: ', err);
                    logStatus('è¤‡è£½å¤±æ•—ï¼Œæ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æˆ–æœªæˆäºˆæ¬Šé™ã€‚', 'red');
                });
            });

            const setupWebSocket = () => {
                const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/api/ws`);
                ws.onopen = () => logStatus('WebSocket é€£ç·šæˆåŠŸã€‚', 'blue');
                ws.onclose = () => {
                    logStatus('WebSocket é€£ç·šå·²ä¸­æ–·ã€‚5 ç§’å¾Œå˜—è©¦é‡æ–°é€£ç·š...', 'orange');
                    setTimeout(setupWebSocket, 5000);
                };
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'STATUS_UPDATE') {
                        logStatus('æ”¶åˆ°ç‹€æ…‹æ›´æ–°é€šçŸ¥ï¼Œæ­£åœ¨åˆ·æ–°å„€è¡¨æ¿...', 'purple');
                        fetchAnalysisStatus();
                    }
                };
            };

            const centerActiveNavButton = () => {
                const activeNavButton = document.querySelector('.top-nav a.active');
                if (activeNavButton) {
                    activeNavButton.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            };

            (async () => {
                logStatus('é é¢è¼‰å…¥å®Œæˆï¼Œæ­£åœ¨åˆå§‹åŒ–...');
                await Promise.all([
                    checkKeysAndLoadModels(),
                    renderFileList(),
                    fetchAnalysisStatus()
                ]);
                setupWebSocket();
                logStatus('åˆå§‹åŒ–å®Œæˆã€‚', 'green');
                setTimeout(centerActiveNavButton, 100);
            })();
        });
    </script>
</body>
</html>
