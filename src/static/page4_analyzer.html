<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é é¢å››ï¼šAI åˆ†æ</title>
    <link rel="stylesheet" href="/static/css/nav.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/page4.css">
</head>
<body>
    <nav class="top-nav">
        <ul>
            <li><a href="/">é³³å‡°ä¸»é </a></li>
            <li><a href="/page1">ç¶²å€æå–</a></li>
            <li><a href="/page2">æ‰¹æ¬¡ä¸‹è¼‰</a></li>
            <li><a href="/page3">æª”æ¡ˆè™•ç†</a></li>
            <li><a href="/page4" class="active">AI åˆ†æ</a></li>
            <li><a href="/page5">å‚™ä»½ç®¡ç†</a></li>
            <li><a href="/page6">é‡‘é‘°ç®¡ç†</a></li>
            <li><a href="/page7">æç¤ºè©ç®¡ç†</a></li>
        </ul>
    </nav>

    <div class="content">
        <!-- Panel 1: æª”æ¡ˆé¸æ“‡èˆ‡ç¬¬ä¸€éšæ®µåˆ†æ -->
        <div class="panel">
            <h1>AI åˆ†ææµç¨‹</h1>
            <p>è«‹å¾ä¸‹æ–¹åˆ—è¡¨ä¸­å‹¾é¸æ‚¨æƒ³åˆ†æçš„æª”æ¡ˆï¼Œé¸æ“‡æ¨¡å‹å¾Œå•Ÿå‹•ç¬¬ä¸€éšæ®µåˆ†æã€‚</p>
            <div class="management-links">
                <a href="/page6" class="button-link">ç®¡ç† API é‡‘é‘°</a>
                <a href="/page7" class="button-link">ç®¡ç†æç¤ºè©</a>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label for="stage1-model-select">é¸æ“‡ç¬¬ä¸€éšæ®µåˆ†ææ¨¡å‹:</label>
                <select id="stage1-model-select" disabled>
                    <option value="">è«‹å…ˆåœ¨ã€Œé‡‘é‘°ç®¡ç†ã€é é¢æ–°å¢æœ‰æ•ˆçš„ API é‡‘é‘°</option>
                </select>
            </div>

            <div style="margin-bottom: 10px; margin-top: 20px;">
                <button id="select-all-button">å…¨é¸</button>
                <button id="deselect-all-button">å–æ¶ˆå…¨é¸</button>
            </div>

            <div id="file-list-container">
                <p>æ­£åœ¨è¼‰å…¥å·²è™•ç†çš„æª”æ¡ˆ...</p>
            </div>

            <div style="margin-top: 20px;">
                <button id="start-stage1-btn">ğŸš€ é–‹å§‹ç¬¬ä¸€éšæ®µåˆ†æ</button>
            </div>
        </div>

        <!-- Panel 2: åˆ†æé€²åº¦å„€è¡¨æ¿ -->
        <div class="panel">
            <h2>åˆ†æé€²åº¦å„€è¡¨æ¿</h2>
            <p>æ­¤è™•æœƒé¡¯ç¤ºæ‰€æœ‰åˆ†æä»»å‹™çš„å³æ™‚ç‹€æ…‹ã€‚ç¬¬ä¸€éšæ®µå®Œæˆå¾Œï¼Œæ‚¨å¯å‹¾é¸æª”æ¡ˆä»¥é€²è¡Œç¬¬äºŒéšæ®µåˆ†æã€‚</p>

            <div class="form-group" style="margin-top: 20px;">
                <label for="stage2-model-select">é¸æ“‡ç¬¬äºŒéšæ®µåˆ†ææ¨¡å‹:</label>
                <select id="stage2-model-select" disabled>
                    <option value="">è«‹å…ˆåœ¨ã€Œé‡‘é‘°ç®¡ç†ã€é é¢æ–°å¢æœ‰æ•ˆçš„ API é‡‘é‘°</option>
                </select>
            </div>

            <div id="analysis-dashboard-container" style="margin-top: 10px;">
                <p>æ­£åœ¨ç­‰å¾…åˆ†æä»»å‹™...</p>
            </div>

            <div style="margin-top: 20px;">
                <button id="start-stage2-btn">ğŸ”¥ é–‹å§‹ç¬¬äºŒéšæ®µåˆ†æ</button>
            </div>
        </div>

        <!-- Panel 3: ç‹€æ…‹æ—¥èªŒ -->
        <div class="panel">
            <div class="panel-header">
                <h2>ç‹€æ…‹æ—¥èªŒ</h2>
                <button id="copy-log-button" class="copy-button" title="è¤‡è£½æ—¥èªŒ">ğŸ“„</button>
            </div>
            <div id="status-area"></div>
        </div>
    </div>

    <!-- Modal for JSON/Error details -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title">è©³ç´°è³‡è¨Š</h3>
            <pre id="modal-body"></pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Cache ---
            const fileListContainer = document.getElementById('file-list-container');
            const dashboardContainer = document.getElementById('analysis-dashboard-container');
            const selectAllButton = document.getElementById('select-all-button');
            const deselectAllButton = document.getElementById('deselect-all-button');
            const startStage1Btn = document.getElementById('start-stage1-btn');
            const startStage2Btn = document.getElementById('start-stage2-btn');
            const statusArea = document.getElementById('status-area');
            const copyLogButton = document.getElementById('copy-log-button');
            const stage1ModelSelect = document.getElementById('stage1-model-select');
            const stage2ModelSelect = document.getElementById('stage2-model-select');
            const modal = document.getElementById('details-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeModal = document.querySelector('.close-button');

            // --- State ---
            let analysisTasks = [];

            // --- Utility Functions ---
            const formatTaipeiTime = (isoString) => {
                if (!isoString) return 'ç„¡æ•ˆæ™‚é–“';
                try {
                    return new Date(isoString).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false }).replace(/\//g, '-');
                } catch (e) { return 'æ™‚é–“æ ¼å¼éŒ¯èª¤'; }
            };

            const logStatus = (message, color = 'black') => {
                const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
                statusArea.insertAdjacentHTML('afterbegin', `<p style="color: ${color};">[${timestamp}] ${message}</p>`);
            };

            // --- Modal Logic ---
            const showModal = (title, content) => {
                modalTitle.textContent = title;
                modalBody.textContent = content;
                modal.style.display = 'block';
            };
            closeModal.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == modal) modal.style.display = 'none';
            };

            // --- Core Render Functions ---
            const renderFileList = async () => {
                try {
                    const response = await fetch('/api/analyzer/processed_files');
                    if (!response.ok) throw new Error('ç„¡æ³•ç²å–å·²è™•ç†æª”æ¡ˆ');
                    const files = await response.json();
                    if (files.length === 0) {
                        fileListContainer.innerHTML = '<p>æ²’æœ‰å¯ä¾›åˆ†æçš„æª”æ¡ˆã€‚</p>';
                        return;
                    }
                    let html = `<table class="results-table"><thead><tr><th><input type="checkbox" id="select-all-header-checkbox"></th><th>æª”æ¡ˆåç¨±</th></tr></thead><tbody>`;
                    files.forEach(file => {
                        html += `<tr><td><input type="checkbox" class="file-checkbox" value="${file.id}"></td><td>${file.filename}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    fileListContainer.innerHTML = html;
                } catch (error) {
                    fileListContainer.innerHTML = `<p style="color:red;">${error.message}</p>`;
                }
            };

            const renderAnalysisDashboard = () => {
                if (analysisTasks.length === 0) {
                    dashboardContainer.innerHTML = '<p>ç›®å‰æ²’æœ‰åˆ†æä»»å‹™ã€‚</p>';
                    return;
                }

                const getStatusHTML = (status, errorLog) => {
                    switch (status) {
                        case 'pending': return `<span class="status-pending">â³ ç­‰å¾…ä¸­</span>`;
                        case 'processing': return `<span class="status-analyzing">ğŸ”„ è™•ç†ä¸­...</span>`;
                        case 'completed': return `<span class="status-analyzed">âœ… å®Œæˆ</span>`;
                        case 'failed': return `<span class="status-error" title="${errorLog || ''}">âŒ å¤±æ•—</span>`;
                        default: return `<span>${status || 'æœªçŸ¥'}</span>`;
                    }
                };

                const getActionsHTML = (task) => {
                    let actions = [];
                    if (task.stage1_status === 'completed') {
                        actions.push(`<button class="action-btn" data-action="view-json" data-task-id="${task.id}">æª¢è¦–JSON</button>`);
                    }
                    if (task.stage2_status === 'completed' && task.stage2_report_path) {
                        const reportFilename = task.stage2_report_path.split(/[\\/]/).pop();
                        const reportUrl = `/reports/${reportFilename}`;
                        actions.push(`<a href="${reportUrl}" target="_blank" class="button-link-inline">æª¢è¦–å ±å‘Š</a>`);
                    }
                    if (task.stage1_status === 'failed') {
                        actions.push(`<button class="action-btn" data-action="retry-stage1" data-task-id="${task.id}" data-file-id="${task.file_id}">é‡è©¦S1</button>`);
                        actions.push(`<button class="action-btn" data-action="view-error" data-task-id="${task.id}" data-stage="1">æŸ¥çœ‹éŒ¯èª¤</button>`);
                    }
                     if (task.stage2_status === 'failed') {
                        actions.push(`<button class="action-btn" data-action="retry-stage2" data-task-id="${task.id}">é‡è©¦S2</button>`);
                        actions.push(`<button class="action-btn" data-action="view-error" data-task-id="${task.id}" data-stage="2">æŸ¥çœ‹éŒ¯èª¤</button>`);
                    }
                    return actions.join(' ');
                };

                let html = `<table class="results-table">
                    <thead><tr>
                        <th><input type="checkbox" id="dashboard-select-all"></th>
                        <th>æª”æ¡ˆåç¨±</th><th>ç¬¬ä¸€éšæ®µç‹€æ…‹</th><th>ç¬¬äºŒéšæ®µç‹€æ…‹</th><th>æ“ä½œ</th>
                    </tr></thead><tbody>`;

                analysisTasks.forEach(task => {
                    const checkboxDisabled = task.stage1_status !== 'completed' || task.stage2_status === 'processing' || task.stage2_status === 'completed';
                    html += `<tr>
                        <td><input type="checkbox" class="dashboard-checkbox" value="${task.id}" ${checkboxDisabled ? 'disabled' : ''}></td>
                        <td>${task.filename}</td>
                        <td>${getStatusHTML(task.stage1_status, task.stage1_error_log)}</td>
                        <td>${getStatusHTML(task.stage2_status, task.stage2_error_log)}</td>
                        <td>${getActionsHTML(task)}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                dashboardContainer.innerHTML = html;
            };

            // --- API Call Functions ---
            const fetchAnalysisStatus = async () => {
                try {
                    const response = await fetch('/api/analyzer/analysis_status');
                    if (!response.ok) throw new Error('ç„¡æ³•ç²å–åˆ†æç‹€æ…‹');
                    analysisTasks = await response.json();
                    renderAnalysisDashboard();
                } catch (error) {
                    logStatus(`ç²å–ç‹€æ…‹å¤±æ•—: ${error.message}`, 'red');
                }
            };

            const fetchAndRenderModels = async () => {
                try {
                    const response = await fetch('/api/analyzer/models');
                    if (!response.ok) throw new Error('ç„¡æ³•ç²å–æ¨¡å‹åˆ—è¡¨');
                    const models = await response.json();
                    stage1ModelSelect.innerHTML = '';
                    stage2ModelSelect.innerHTML = '';
                    models.forEach(model => {
                        const option1 = document.createElement('option');
                        option1.value = option1.textContent = model;
                        stage1ModelSelect.appendChild(option1);
                        const option2 = document.createElement('option');
                        option2.value = option2.textContent = model;
                        stage2ModelSelect.appendChild(option2);
                    });
                } catch (error) {
                    logStatus(`æ¨¡å‹è¼‰å…¥å¤±æ•—: ${error.message}`, 'red');
                }
            };

            const checkKeysAndLoadModels = async () => {
                try {
                    const response = await fetch('/api/keys');
                    const keys = await response.json();
                    const validKeys = keys.filter(k => k.is_valid);
                    if (validKeys.length > 0) {
                        stage1ModelSelect.disabled = false;
                        stage2ModelSelect.disabled = false;
                        await fetchAndRenderModels();
                    } else {
                        stage1ModelSelect.disabled = true;
                        stage2ModelSelect.disabled = true;
                        logStatus('åµæ¸¬åˆ°ç„¡æœ‰æ•ˆ API é‡‘é‘°ï¼Œæ¨¡å‹é¸å–®å·²ç¦ç”¨ã€‚', 'orange');
                    }
                } catch (error) {
                    logStatus(`æª¢æŸ¥ API é‡‘é‘°æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'red');
                    stage1ModelSelect.disabled = true;
                    stage2ModelSelect.disabled = true;
                }
            };

            // --- Event Listeners ---
            startStage1Btn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => parseInt(cb.value, 10));
                if (selectedIds.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æª”æ¡ˆã€‚');
                if (stage1ModelSelect.disabled) return alert('è«‹å…ˆæ–°å¢æœ‰æ•ˆçš„ API é‡‘é‘°æ‰èƒ½é–‹å§‹åˆ†æã€‚');
                const modelName = stage1ModelSelect.value;
                if (!modelName) return alert('è«‹é¸æ“‡ç¬¬ä¸€éšæ®µæ¨¡å‹ã€‚');

                logStatus(`å•Ÿå‹•ç¬¬ä¸€éšæ®µåˆ†æï¼Œå…± ${selectedIds.length} å€‹æª”æ¡ˆ...`, 'blue');
                await fetch('/api/analyzer/start_stage1_analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ file_ids: selectedIds, model_name: modelName })
                });
            });

            startStage2Btn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.dashboard-checkbox:checked')).map(cb => parseInt(cb.value, 10));
                if (selectedIds.length === 0) return alert('è«‹åœ¨å„€è¡¨æ¿ä¸­å‹¾é¸ç¬¬ä¸€éšæ®µå·²å®Œæˆçš„ä»»å‹™ã€‚');
                if (stage2ModelSelect.disabled) return alert('è«‹å…ˆæ–°å¢æœ‰æ•ˆçš„ API é‡‘é‘°æ‰èƒ½é–‹å§‹åˆ†æã€‚');
                const modelName = stage2ModelSelect.value;
                if (!modelName) return alert('è«‹é¸æ“‡ç¬¬äºŒéšæ®µæ¨¡å‹ã€‚');

                logStatus(`å•Ÿå‹•ç¬¬äºŒéšæ®µåˆ†æï¼Œå…± ${selectedIds.length} å€‹ä»»å‹™...`, 'blue');
                await fetch('/api/analyzer/start_stage2_analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ task_ids: selectedIds, model_name: modelName })
                });
            });

            dashboardContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (!target.classList.contains('action-btn')) return;

                const action = target.dataset.action;
                const taskId = parseInt(target.dataset.taskId, 10);
                const task = analysisTasks.find(t => t.id === taskId);

                if (action === 'view-json') {
                    const response = await fetch(`/api/analyzer/stage1_result/${taskId}`);
                    const data = await response.json();
                    showModal(`ä»»å‹™ #${taskId} çš„ JSON çµæœ`, JSON.stringify(data, null, 2));
                } else if (action === 'view-error') {
                    const stage = target.dataset.stage;
                    const errorLog = stage === '1' ? task.stage1_error_log : task.stage2_error_log;
                    showModal(`ä»»å‹™ #${taskId} çš„éŒ¯èª¤æ—¥èªŒ`, errorLog || 'æ²’æœ‰è©³ç´°çš„éŒ¯èª¤è³‡è¨Šã€‚');
                } else if (action === 'retry-stage1') {
                    const fileId = parseInt(target.dataset.fileId, 10);
                    const modelName = stage1ModelSelect.value;
                    await fetch('/api/analyzer/start_stage1_analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ file_ids: [fileId], model_name: modelName })
                    });
                } else if (action === 'retry-stage2') {
                     const modelName = stage2ModelSelect.value;
                     await fetch('/api/analyzer/start_stage2_analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ task_ids: [taskId], model_name: modelName })
                    });
                }
            });

            selectAllButton.addEventListener('click', () => document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = true));
            deselectAllButton.addEventListener('click', () => document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false));
            dashboardContainer.addEventListener('change', e => {
                if (e.target.id === 'dashboard-select-all') {
                    document.querySelectorAll('.dashboard-checkbox:not(:disabled)').forEach(cb => cb.checked = e.target.checked);
                }
            });

            // --- WebSocket Setup ---
            const setupWebSocket = () => {
                const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/api/ws`);
                ws.onopen = () => logStatus('WebSocket é€£ç·šæˆåŠŸã€‚', 'blue');
                ws.onclose = () => {
                    logStatus('WebSocket é€£ç·šå·²ä¸­æ–·ã€‚5 ç§’å¾Œå˜—è©¦é‡æ–°é€£ç·š...', 'orange');
                    setTimeout(setupWebSocket, 5000);
                };
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'STATUS_UPDATE') {
                        logStatus('æ”¶åˆ°ç‹€æ…‹æ›´æ–°é€šçŸ¥ï¼Œæ­£åœ¨åˆ·æ–°å„€è¡¨æ¿...', 'purple');
                        fetchAnalysisStatus();
                    }
                };
            };

            // --- Nav Bar Centering ---
            const centerActiveNavButton = () => {
                const activeNavButton = document.querySelector('.top-nav a.active');
                if (activeNavButton) {
                    activeNavButton.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            };

            // --- Initial Load ---
            (async () => {
                logStatus('é é¢è¼‰å…¥å®Œæˆï¼Œæ­£åœ¨åˆå§‹åŒ–...');
                await Promise.all([
                    checkKeysAndLoadModels(),
                    renderFileList(),
                    fetchAnalysisStatus()
                ]);
                setupWebSocket();
                logStatus('åˆå§‹åŒ–å®Œæˆã€‚', 'green');
                setTimeout(centerActiveNavButton, 100);
            })();
        });
    </script>
</body>
</html>
