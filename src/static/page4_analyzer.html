<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>頁面四：AI 分析</title>
    <link rel="stylesheet" href="/static/css/nav.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/page4.css">
</head>
<body>
    <nav class="top-nav">
        <ul>
            <li><a href="/">鳳凰主頁</a></li>
            <li><a href="/page1">網址提取</a></li>
            <li><a href="/page2">批次下載</a></li>
            <li><a href="/page3">檔案處理</a></li>
            <li><a href="/page4" class="active">AI 分析</a></li>
            <li><a href="/page5">備份管理</a></li>
            <li><a href="/page6">金鑰管理</a></li>
            <li><a href="/page7">提示詞管理</a></li>
        </ul>
    </nav>

    <div class="content">
        <!-- Panel 1: 檔案選擇與第一階段分析 -->
        <div class="panel">
            <h1>AI 分析流程</h1>
            <p>請從下方列表中勾選您想分析的檔案，選擇模型後啟動第一階段分析。</p>
            <div class="management-links">
                <a href="/page6" class="button-link">管理 API 金鑰</a>
                <a href="/page7" class="button-link">管理提示詞</a>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label for="stage1-model-select">選擇第一階段分析模型:</label>
                <select id="stage1-model-select" disabled>
                    <option value="">請先在「金鑰管理」頁面新增有效的 API 金鑰</option>
                </select>
            </div>

            <div style="margin-bottom: 10px; margin-top: 20px;">
                <button id="select-all-button">全選</button>
                <button id="deselect-all-button">取消全選</button>
            </div>

            <div id="file-list-container">
                <p>正在載入已處理的檔案...</p>
            </div>

            <div style="margin-top: 20px;">
                <button id="start-stage1-btn">🚀 開始第一階段分析</button>
            </div>
        </div>

        <!-- Panel 2: 分析進度儀表板 -->
        <div class="panel">
            <h2>分析進度儀表板</h2>
            <p>此處會顯示所有分析任務的即時狀態。第一階段完成後，您可勾選檔案以進行第二階段分析。</p>

            <div class="form-group" style="margin-top: 20px;">
                <label for="stage2-model-select">選擇第二階段分析模型:</label>
                <select id="stage2-model-select" disabled>
                    <option value="">請先在「金鑰管理」頁面新增有效的 API 金鑰</option>
                </select>
            </div>

            <div id="analysis-dashboard-container" style="margin-top: 10px;">
                <p>正在等待分析任務...</p>
            </div>

            <div style="margin-top: 20px;">
                <button id="start-stage2-btn">🔥 開始第二階段分析</button>
            </div>
        </div>

        <!-- Panel 3: 狀態日誌 -->
        <div class="panel">
            <div class="panel-header">
                <h2>狀態日誌</h2>
                <button id="copy-log-button" class="copy-button" title="複製日誌">複製</button>
            </div>
            <div id="status-area"></div>
        </div>
    </div>

    <!-- Modal for JSON/Error details -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title">詳細資訊</h3>
            <pre id="modal-body"></pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Cache ---
            const fileListContainer = document.getElementById('file-list-container');
            const dashboardContainer = document.getElementById('analysis-dashboard-container');
            const selectAllButton = document.getElementById('select-all-button');
            const deselectAllButton = document.getElementById('deselect-all-button');
            const startStage1Btn = document.getElementById('start-stage1-btn');
            const startStage2Btn = document.getElementById('start-stage2-btn');
            const statusArea = document.getElementById('status-area');
            const copyLogButton = document.getElementById('copy-log-button');
            const stage1ModelSelect = document.getElementById('stage1-model-select');
            const stage2ModelSelect = document.getElementById('stage2-model-select');
            // Modal is no longer used for JSON, but might be for other things. Keep it for now.
            const modal = document.getElementById('details-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeModal = document.querySelector('.close-button');

            // --- State ---
            let analysisTasks = [];

            // --- Utility Functions ---
            const formatTaipeiTime = (isoString) => {
                if (!isoString) return '無效時間';
                try {
                    return new Date(isoString).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false }).replace(/\//g, '-');
                } catch (e) { return '時間格式錯誤'; }
            };

            const logStatus = (message, color = 'black') => {
                const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
                statusArea.insertAdjacentHTML('afterbegin', `<p style="color: ${color};">[${timestamp}] ${message}</p>`);
            };

            const translateStatus = (status) => {
                if (!status) return 'N/A';
                const statusMap = {
                    'pending': '⏳ 等待中',
                    'processing': '🔄 處理中',
                    'completed': '✅ 完成',
                    'failed': '❌ 失敗',
                    'processed': '可供分析',
                    'analyzed': '分析完成'
                };
                return statusMap[status.toLowerCase()] || status;
            };

            // --- Core Render Functions ---
            const renderFileList = async () => {
                try {
                    const response = await fetch('/api/analyzer/processed_files');
                    if (!response.ok) throw new Error('無法獲取已處理檔案');
                    const files = await response.json();
                    if (files.length === 0) {
                        fileListContainer.innerHTML = '<p>沒有可供分析的檔案。</p>';
                        return;
                    }
                    let html = `<table class="results-table"><thead><tr><th><input type="checkbox" id="select-all-header-checkbox"></th><th>檔案名稱</th><th>狀態</th></tr></thead><tbody>`;
                    files.forEach(file => {
                        const isSelectable = file.status === 'processed' || file.status === 'analyzed';
                        const checkbox = `<input type="checkbox" class="file-checkbox" value="${file.id}" ${isSelectable ? '' : 'disabled'}>`;
                        const statusMessage = isSelectable ? '可進行分析' : (file.status_message || '不適用');
                        const statusClass = isSelectable ? 'status-completed' : 'status-error';

                        html += `<tr>
                                     <td>${checkbox}</td>
                                     <td title="${file.filename}">${file.filename}</td>
                                     <td class="${statusClass}" title="${statusMessage}">${translateStatus(file.status)}</td>
                                 </tr>`;
                    });
                    html += '</tbody></table>';
                    fileListContainer.innerHTML = html;
                } catch (error) {
                    fileListContainer.innerHTML = `<p style="color:red;">${error.message}</p>`;
                }
            };

            const renderAnalysisDashboard = () => {
                if (analysisTasks.length === 0) {
                    dashboardContainer.innerHTML = '<p>目前沒有分析任務。</p>';
                    return;
                }

                const getStatusHTML = (task, stage) => {
                    const status = stage === 1 ? task.stage1_status : task.stage2_status;
                    const errorLog = stage === 1 ? task.stage1_error_log : task.stage2_error_log;
                    const model = stage === 1 ? task.stage1_model : task.stage2_model_used;

                    const translatedStatus = translateStatus(status);
                    let statusClass = '';
                    if (status) {
                        if (status.includes('pending')) statusClass = 'status-pending';
                        else if (status.includes('processing')) statusClass = 'status-analyzing';
                        else if (status.includes('completed')) statusClass = 'status-analyzed';
                        else if (status.includes('failed')) statusClass = 'status-error';
                    }

                    let displayText = translatedStatus;
                    if (status === 'processing' && model) {
                        displayText = `${translatedStatus} (${model.replace('models/', '')})`
                    }

                    return `<span class="${statusClass}" title="${errorLog || ''}">${displayText}</span>`;
                };

                const getActionsHTML = (task) => {
                    let actions = [];
                    if (task.stage1_status === 'completed') {
                        actions.push(`<button class="action-btn btn-view" data-action="view-json" data-task-id="${task.id}">檢視JSON</button>`);
                    }
                    if (task.stage2_status === 'completed' && task.stage2_report_path) {
                        const reportFilename = task.stage2_report_path.split(/[\\/]/).pop();
                        const reportUrl = `/reports/${reportFilename}`;
                        actions.push(`<a href="${reportUrl}" target="_blank" class="action-btn btn-report">檢視報告</a>`);
                    }
                    if (task.stage1_status === 'failed') {
                        actions.push(`<button class="action-btn btn-log" data-action="view-log" data-task-id="${task.id}" data-stage="1">日誌</button>`);
                        actions.push(`<button class="action-btn btn-retry" data-action="retry-stage1" data-task-id="${task.id}" data-file-id="${task.file_id}">重試(1)</button>`);
                    }
                     if (task.stage2_status === 'failed') {
                        actions.push(`<button class="action-btn btn-log" data-action="view-log" data-task-id="${task.id}" data-stage="2">日誌</button>`);
                        actions.push(`<button class="action-btn btn-retry" data-action="retry-stage2" data-task-id="${task.id}">重試(2)</button>`);
                    }
                    return actions.join(' ');
                };

                let html = `<table class="results-table">
                    <thead><tr>
                        <th><input type="checkbox" id="dashboard-select-all"></th>
                        <th>檔案名稱</th><th>作者</th><th>模型</th><th>Token 消耗</th><th>第一階段狀態</th><th>第二階段狀態</th><th>操作</th>
                    </tr></thead><tbody>`;

                analysisTasks.forEach(task => {
                    const checkboxDisabled = task.stage1_status !== 'completed' || task.stage2_status === 'processing' || task.stage2_status === 'completed';
                    const detailUrl = task.file_hash ? `/static/page8_file_details.html?hash=${task.file_hash}` : '#';
                    const filenameLink = task.file_hash ? `<a href="${detailUrl}" title="${task.filename}">${task.filename}</a>` : `<span title="${task.filename}">${task.filename}</span>`;
                    const authorLink = task.author ? (task.file_hash ? `<a href="${detailUrl}" title="${task.author}">${task.author}</a>` : `<span title="${task.author}">${task.author}</span>`) : 'N/A';

                    const modelInfo = [task.stage1_model, task.stage2_model_used].filter(Boolean).map(m => m.replace('models/', '')).join('<br>');
                    const tokenUsage = (task.stage1_token_usage || 0) + (task.stage2_token_usage || 0);

                    html += `<tr id="task-row-${task.id}">
                        <td><input type="checkbox" class="dashboard-checkbox" value="${task.id}" ${checkboxDisabled ? 'disabled' : ''}></td>
                        <td>${filenameLink}</td>
                        <td>${authorLink}</td>
                        <td>${modelInfo || 'N/A'}</td>
                        <td>${tokenUsage > 0 ? tokenUsage.toLocaleString() : 'N/A'}</td>
                        <td>${getStatusHTML(task, 1)}</td>
                        <td>${getStatusHTML(task, 2)}</td>
                        <td>${getActionsHTML(task)}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                dashboardContainer.innerHTML = html;
            };

            // --- API Call Functions ---
            const fetchAnalysisStatus = async () => {
                try {
                    const response = await fetch('/api/analyzer/analysis_status');
                    if (!response.ok) throw new Error('無法獲取分析狀態');
                    analysisTasks = await response.json();
                    renderAnalysisDashboard();
                } catch (error) {
                    logStatus(`獲取狀態失敗: ${error.message}`, 'red');
                }
            };

            const populateModelSelector = (selectorId, models) => {
                const selector = document.getElementById(selectorId);
                selector.innerHTML = ''; // 清空舊選項
                const priorityOrder = ["models/gemini-2.0-flash-lite", "models/gemini-2.0-flash", "models/gemini-2.5-flash-lite", "models/gemini-2.5-flash"];
                const sortedModels = [...models].sort((a, b) => {
                    let aPriority = priorityOrder.indexOf(a);
                    let bPriority = priorityOrder.indexOf(b);
                    if (aPriority === -1) aPriority = priorityOrder.length + 1;
                    if (bPriority === -1) bPriority = priorityOrder.length + 1;
                    if (aPriority !== bPriority) return aPriority - bPriority;
                    return a.localeCompare(b);
                });
                sortedModels.forEach((modelName, index) => {
                    const option = document.createElement('option');
                    option.value = modelName;
                    option.textContent = modelName.replace('models/', '');
                    if (index === 0) option.selected = true;
                    selector.appendChild(option);
                });
            };

            const fetchAndRenderModels = async () => {
                try {
                    const response = await fetch('/api/keys/models');
                    if (!response.ok) throw new Error('無法獲取模型列表');
                    const models = await response.json();
                    populateModelSelector('stage1-model-select', models);
                    populateModelSelector('stage2-model-select', models);
                } catch (error) {
                    logStatus(`模型載入失敗: ${error.message}`, 'red');
                }
            };

            const checkKeysAndLoadModels = async () => {
                try {
                    const response = await fetch('/api/keys');
                    const keys = await response.json();
                    const validKeys = keys.filter(k => k.is_valid);
                    if (validKeys.length > 0) {
                        stage1ModelSelect.disabled = false;
                        stage2ModelSelect.disabled = false;
                        await fetchAndRenderModels();
                    } else {
                        stage1ModelSelect.disabled = true;
                        stage2ModelSelect.disabled = true;
                        logStatus('偵測到無有效 API 金鑰，模型選單已禁用。', 'orange');
                    }
                } catch (error) {
                    logStatus(`檢查 API 金鑰時發生錯誤: ${error.message}`, 'red');
                    stage1ModelSelect.disabled = true;
                    stage2ModelSelect.disabled = true;
                }
            };

            // --- Event Listeners ---
            startStage1Btn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => parseInt(cb.value, 10));
                if (selectedIds.length === 0) return alert('請至少選擇一個檔案。');
                if (stage1ModelSelect.disabled) return alert('請先新增有效的 API 金鑰才能開始分析。');
                const modelName = stage1ModelSelect.value;
                if (!modelName) return alert('請選擇第一階段模型。');

                logStatus(`啟動第一階段分析，共 ${selectedIds.length} 個檔案...`, 'blue');
                try {
                    const response = await fetch('/api/analyzer/start_stage1_analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ file_ids: selectedIds, model_name: modelName })
                    });
                    if (response.ok) {
                        logStatus('分析請求已成功發送，正在更新儀表板狀態...', 'purple');
                        await fetchAnalysisStatus();
                    } else {
                        const errorData = await response.json().catch(() => ({ error: '無法解析伺服器錯誤回應' }));
                        logStatus(`啟動分析失敗: ${errorData.error || response.statusText}`, 'red');
                    }
                } catch (error) {
                    logStatus(`啟動分析時發生網路錯誤: ${error.message}`, 'red');
                }
            });

            startStage2Btn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.dashboard-checkbox:checked')).map(cb => parseInt(cb.value, 10));
                if (selectedIds.length === 0) return alert('請在儀表板中勾選第一階段已完成的任務。');
                if (stage2ModelSelect.disabled) return alert('請先新增有效的 API 金鑰才能開始分析。');
                const modelName = stage2ModelSelect.value;
                if (!modelName) return alert('請選擇第二階段模型。');

                logStatus(`啟動第二階段分析，共 ${selectedIds.length} 個任務...`, 'blue');
                await fetch('/api/analyzer/start_stage2_analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ task_ids: selectedIds, model_name: modelName })
                });
            });

            dashboardContainer.addEventListener('click', async (e) => {
                const target = e.target.closest('.action-btn');
                if (!target) return;

                e.preventDefault();

                const action = target.dataset.action;
                const taskId = parseInt(target.dataset.taskId, 10);
                const task = analysisTasks.find(t => t.id === taskId);
                const currentRow = document.getElementById(`task-row-${taskId}`);
                if (!currentRow) return;

                const removeExistingDetailsRow = () => {
                    const existingDetails = document.querySelector('.details-row');
                    if(existingDetails) existingDetails.remove();
                };

                const createDetailsRow = (id, content) => {
                    const detailsRow = document.createElement('tr');
                    detailsRow.id = id;
                    detailsRow.classList.add('details-row');
                    detailsRow.innerHTML = `<td colspan="8" class="log-details"><pre>${content}</pre></td>`;
                    currentRow.after(detailsRow);
                    return detailsRow;
                }

                if (action === 'view-json') {
                    const detailsId = `json-details-${taskId}`;
                    const existingRow = document.getElementById(detailsId);
                    if (existingRow) return existingRow.remove();

                    removeExistingDetailsRow();
                    const placeholderRow = createDetailsRow(detailsId, '🔄 正在載入 JSON 資料...');

                    try {
                        const response = await fetch(`/api/analyzer/stage1_result/${taskId}`);
                        if (!response.ok) throw new Error(`伺服器回應錯誤 (狀態 ${response.status})`);
                        const data = await response.json();
                        placeholderRow.querySelector('pre').textContent = JSON.stringify(data, null, 2);
                    } catch (error) {
                        placeholderRow.querySelector('pre').textContent = `載入 JSON 失敗: ${error.message}`;
                        placeholderRow.querySelector('td').style.color = 'red';
                    }
                } else if (action === 'view-log') {
                    const detailsId = `log-details-${taskId}`;
                    const existingRow = document.getElementById(detailsId);
                    if (existingRow) return existingRow.remove();

                    removeExistingDetailsRow();
                    const stage = target.dataset.stage;
                    const errorLog = (stage === '1' ? task.stage1_error_log : task.stage2_error_log) || '沒有詳細的錯誤資訊。';
                    createDetailsRow(detailsId, errorLog);

                } else if (action === 'retry-stage1') {
                    const fileId = parseInt(target.dataset.fileId, 10);
                    const modelName = stage1ModelSelect.value;
                    if (!modelName) return alert('請選擇第一階段模型。');
                    logStatus(`正在為檔案 #${fileId} 重試第一階段分析...`, 'blue');
                    await fetch('/api/analyzer/start_stage1_analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ file_ids: [fileId], model_name: modelName })
                    });
                    await fetchAnalysisStatus();
                } else if (action === 'retry-stage2') {
                     const modelName = stage2ModelSelect.value;
                     if (!modelName) return alert('請選擇第二階段模型。');
                     logStatus(`正在為任務 #${taskId} 重試第二階段分析...`, 'blue');
                     await fetch('/api/analyzer/start_stage2_analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ task_ids: [taskId], model_name: modelName })
                    });
                    await fetchAnalysisStatus();
                }
            });

            selectAllButton.addEventListener('click', () => document.querySelectorAll('.file-checkbox:not(:disabled)').forEach(cb => cb.checked = true));
            deselectAllButton.addEventListener('click', () => document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false));
            dashboardContainer.addEventListener('change', e => {
                if (e.target.id === 'dashboard-select-all') {
                    document.querySelectorAll('.dashboard-checkbox:not(:disabled)').forEach(cb => e.target.checked ? cb.checked = true : cb.checked = false);
                }
            });

            copyLogButton.addEventListener('click', () => {
                const logContent = statusArea.innerText;
                navigator.clipboard.writeText(logContent).then(() => {
                    const originalText = copyLogButton.innerText;
                    copyLogButton.innerText = '已複製 ✅';
                    copyLogButton.disabled = true;
                    setTimeout(() => {
                        copyLogButton.innerText = originalText;
                        copyLogButton.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('無法複製日誌: ', err);
                    logStatus('複製失敗，您的瀏覽器可能不支援或未授予權限。', 'red');
                });
            });

            const setupWebSocket = () => {
                const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/api/ws`);
                ws.onopen = () => logStatus('WebSocket 連線成功。', 'blue');
                ws.onclose = () => {
                    logStatus('WebSocket 連線已中斷。5 秒後嘗試重新連線...', 'orange');
                    setTimeout(setupWebSocket, 5000);
                };
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'STATUS_UPDATE') {
                        logStatus('收到狀態更新通知，正在刷新儀表板...', 'purple');
                        fetchAnalysisStatus();
                    }
                };
            };

            const centerActiveNavButton = () => {
                const activeNavButton = document.querySelector('.top-nav a.active');
                if (activeNavButton) {
                    activeNavButton.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            };

            (async () => {
                logStatus('頁面載入完成，正在初始化...');
                await Promise.all([
                    checkKeysAndLoadModels(),
                    renderFileList(),
                    fetchAnalysisStatus()
                ]);
                setupWebSocket();
                logStatus('初始化完成。', 'green');
                setTimeout(centerActiveNavButton, 100);
            })();
        });
    </script>
</body>
</html>
