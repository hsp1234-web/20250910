<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é é¢å…«ï¼šæª”æ¡ˆç¸½è¦½</title>
    <link rel="stylesheet" href="/static/css/nav.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/page8.css">
</head>
<body>
    <nav class="top-nav">
        <ul>
            <li><a href="/">é³³å‡°ä¸»é </a></li>
            <li><a href="/page1">ç¶²å€æå–</a></li>
            <li><a href="/page2">æ‰¹æ¬¡ä¸‹è¼‰</a></li>
            <li><a href="/page3">æª”æ¡ˆè™•ç†</a></li>
            <li><a href="/page4">AI åˆ†æ</a></li>
            <li><a href="/page5">å‚™ä»½ç®¡ç†</a></li>
            <li><a href="/page6">é‡‘é‘°ç®¡ç†</a></li>
            <li><a href="/page7">æç¤ºè©ç®¡ç†</a></li>
            <!-- This page is not in the main nav, it's accessed via links -->
        </ul>
    </nav>

    <div class="content">
        <div class="panel">
            <h1>æª”æ¡ˆç¸½è¦½</h1>
            <div id="details-container">
                <p>æ­£åœ¨è¼‰å…¥æª”æ¡ˆè©³ç´°è³‡è¨Š...</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const detailsContainer = document.getElementById('details-container');

            const getStatusHTML = (status) => {
                if (!status) return `<span class="status-pending">æœªé–‹å§‹</span>`;
                switch (status.toLowerCase()) {
                    case 'pending': return `<span class="status-pending">â³ ç­‰å¾…ä¸­</span>`;
                    case 'downloading': return `<span class="status-downloading">ğŸ“¥ ä¸‹è¼‰ä¸­</span>`;
                    case 'completed': return `<span class="status-completed">âœ… å·²å®Œæˆ</span>`;
                    case 'processing': return `<span class="status-processing">ğŸ”„ è™•ç†ä¸­</span>`;
                    case 'processed': return `<span class="status-completed">âœ… å·²è™•ç†</span>`;
                    case 'analyzed': return `<span class="status-completed">âœ… å·²åˆ†æ</span>`;
                    case 'failed': return `<span class="status-failed">âŒ å¤±æ•—</span>`;
                    case 'error': return `<span class="status-error">âŒ éŒ¯èª¤</span>`;
                    default: return `<span>${status}</span>`;
                }
            };

            const formatTaipeiTime = (isoString) => {
                if (!isoString) return 'N/A';
                try {
                    return new Date(isoString).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false }).replace(/\//g, '-');
                } catch (e) { return 'æ™‚é–“æ ¼å¼éŒ¯èª¤'; }
            };

            const renderDetails = (data) => {
                const { file_hash, primary_record, all_occurrences, analysis_task } = data;

                // --- æ¸²æŸ“æ‰€æœ‰å‡ºç¾ç´€éŒ„çš„è¡¨æ ¼ ---
                let occurrencesHtml = '<p>ç„¡</p>';
                if (all_occurrences && all_occurrences.length > 0) {
                    occurrencesHtml = `
                        <table class="occurrences-table">
                            <thead>
                                <tr>
                                    <th>ä½œè€…</th>
                                    <th>è¨Šæ¯æ—¥æœŸ</th>
                                    <th>è¨Šæ¯æ™‚é–“</th>
                                    <th>åŸå§‹ç¶²å€</th>
                                    <th>ä¸‹è¼‰ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${all_occurrences.map(occ => `
                                    <tr>
                                        <td>${occ.author || 'N/A'}</td>
                                        <td>${occ.message_date || 'N/A'}</td>
                                        <td>${occ.message_time || 'N/A'}</td>
                                        <td><a href="${occ.url}" target="_blank">æŸ¥çœ‹åŸå§‹é€£çµ</a></td>
                                        <td>${getStatusHTML(occ.status)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                // --- æ¸²æŸ“ AI åˆ†æçµæœ ---
                let stage1Html = getStatusHTML(analysis_task ? analysis_task.stage1_status : 'pending');
                if (analysis_task && analysis_task.stage1_status === 'completed') {
                    stage1Html += ` <button class="button-link-inline btn-view-json" data-task-id="${analysis_task.id}">æŸ¥çœ‹ JSON</button>`;
                } else if (analysis_task && analysis_task.stage1_status === 'failed') {
                    stage1Html += `<br><small style="color: #dc3545;">${analysis_task.stage1_error_log || 'ç„¡è©³ç´°éŒ¯èª¤è³‡è¨Š'}</small>`;
                }

                let stage2Html = getStatusHTML(analysis_task ? analysis_task.stage2_status : 'pending');
                 if (analysis_task && analysis_task.stage2_status === 'completed' && analysis_task.stage2_report_path) {
                    const reportFilename = analysis_task.stage2_report_path.split(/[\\/]/).pop();
                    const reportUrl = `/reports/${reportFilename}`;
                    stage2Html += ` <a href="${reportUrl}" target="_blank" class="button-link-inline">æŸ¥çœ‹å ±å‘Š</a>`;
                } else if (analysis_task && analysis_task.stage2_status === 'failed') {
                     stage2Html += `<br><small style="color: #dc3545;">${analysis_task.stage2_error_log || 'ç„¡è©³ç´°éŒ¯èª¤è³‡è¨Š'}</small>`;
                }


                // --- æ¸²æŸ“ä¸»è¡¨æ ¼ ---
                const mainHtml = `
                    <table class="details-table">
                        <tbody>
                            <tr>
                                <th>æª”æ¡ˆé›œæ¹Š (Hash)</th>
                                <td><pre>${file_hash}</pre></td>
                            </tr>
                            <tr>
                                <th>åŸå§‹æª”å</th>
                                <td>${primary_record.local_path ? primary_record.local_path.split(/[\\/]/).pop() : 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>é¦–æ¬¡å‡ºç¾æ™‚é–“</th>
                                <td>${formatTaipeiTime(primary_record.created_at)}</td>
                            </tr>
                            <tr>
                                <th>é¦–æ¬¡å‡ºç¾ä½œè€…</th>
                                <td>${primary_record.author || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>ä¸‹è¼‰å¾Œçš„æœ¬åœ°è·¯å¾‘</th>
                                <td>${primary_record.local_path || 'N/A'}</td>
                            </tr>
                             <tr>
                                <th>æ‰€æœ‰å‡ºç¾ç´€éŒ„</th>
                                <td><div class="table-responsive-wrapper">${occurrencesHtml}</div></td>
                            </tr>
                            <tr id="stage1-row">
                                <th>AI åˆ†æ - ç¬¬ä¸€éšæ®µ (JSON)</th>
                                <td>${stage1Html}</td>
                            </tr>
                            <tr>
                                <th>ç¬¬ä¸€éšæ®µ Token æ¶ˆè€—</th>
                                <td>${(analysis_task && analysis_task.stage1_token_usage) ? analysis_task.stage1_token_usage.toLocaleString() : 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>AI åˆ†æ - ç¬¬äºŒéšæ®µ (å ±å‘Š)</th>
                                <td>${stage2Html}</td>
                            </tr>
                             <tr>
                                <th>ç¬¬äºŒéšæ®µ Token æ¶ˆè€—</th>
                                <td>${(analysis_task && analysis_task.stage2_token_usage) ? analysis_task.stage2_token_usage.toLocaleString() : 'N/A'}</td>
                            </tr>
                        </tbody>
                    </table>
                `;

                detailsContainer.innerHTML = mainHtml;
            };

            const loadDetails = async () => {
                const params = new URLSearchParams(window.location.search);
                const hash = params.get('hash');
                if (!hash) {
                    detailsContainer.innerHTML = '<p style="color:red;">éŒ¯èª¤ï¼šURL ä¸­ç¼ºå°‘æª”æ¡ˆé›œæ¹Šå€¼ (hash)ã€‚</p>';
                    return;
                }

                try {
                    const response = await fetch(`/api/details/${hash}`);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'ç„¡æ³•è§£æä¼ºæœå™¨éŒ¯èª¤å›æ‡‰' }));
                        throw new Error(errorData.detail || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                    }
                    const data = await response.json();
                    renderDetails(data);
                } catch (error) {
                    detailsContainer.innerHTML = `<p style="color:red;">è¼‰å…¥è©³ç´°è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</p>`;
                }
            };

            loadDetails();

            detailsContainer.addEventListener('click', async (e) => {
                if (!e.target.classList.contains('btn-view-json')) {
                    return;
                }

                const button = e.target;
                const taskId = button.dataset.taskId;
                const stage1Row = document.getElementById('stage1-row');
                const detailsRowId = `json-details-for-${taskId}`;
                const existingDetailsRow = document.getElementById(detailsRowId);

                if (existingDetailsRow) {
                    existingDetailsRow.remove();
                    return;
                }

                // Remove any other details row that might be open
                const anyOpenDetails = document.querySelector('.json-details-row');
                if(anyOpenDetails) anyOpenDetails.remove();

                const detailsRow = document.createElement('tr');
                detailsRow.id = detailsRowId;
                detailsRow.classList.add('json-details-row');
                detailsRow.innerHTML = `<td colspan="2"><pre>æ­£åœ¨è¼‰å…¥ JSON è³‡æ–™...</pre></td>`;
                stage1Row.after(detailsRow);

                try {
                    button.disabled = true;
                    const response = await fetch(`/api/analyzer/stage1_result/${taskId}`);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: `ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ (ç‹€æ…‹ ${response.status})` }));
                        throw new Error(errorData.detail);
                    }
                    const data = await response.json();
                    detailsRow.querySelector('pre').textContent = JSON.stringify(data, null, 2);
                } catch (error) {
                    detailsRow.querySelector('pre').style.color = 'red';
                    detailsRow.querySelector('pre').textContent = `è¼‰å…¥ JSON å¤±æ•—: ${error.message}`;
                } finally {
                    button.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
