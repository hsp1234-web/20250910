## 1016號 - 2025-09-12T11:40:49.814937+08:00

### docs(analysis): 建立 AI 分析流程穩定性報告

- **動機**: 使用者反應目前的 AI 分析流程不穩定，經常因金鑰配額等問題而中斷。為了從根本上解決此問題，在進行任何程式碼修改前，需要先對現有系統進行一次全面的、深入的調查。
- **核心變更**:
    - **深度分析**:
        - 系統性地審閱了 AI 分析流程涉及的所有核心模組，包括 `page4_analyzer.py` (任務調度器), `gemini_manager.py` (API 互動), `key_manager.py` (金鑰管理) 和 `database.py` (狀態紀錄)。
        - **根本原因定位**: 明確了問題的根源在於 `gemini_manager.py` 缺乏智慧故障轉移 (Failover) 機制。它在遇到金鑰失效時，只會用同一把壞掉的金鑰進行重試，而不會自動切換到備用金鑰。
    - **建立分析報告 (`re.md`)**:
        - 根據使用者的指示，將以上所有調查結果、根本原因分析，以及基於此分析提出的三種解決方案（方案一：快速修復、方案二：標本兼治、方案三：全自動化），詳細地撰寫並建立了一份名為 `re.md` 的正式報告文件。
- **成果**: 本次提交的核心成果是一份高品質的技術分析報告 `re.md`。它為我們下一步的決策和開發工作提供了清晰、堅實的數據和理論基礎，確保了後續的程式碼修改將是目標明確且能從根本上解決問題的。

---
## 1015號 - 2025-09-12T07:16:09.887510+08:00

### feat(analyzer): 全面增強 AI 分析頁面與導覽列體驗

- **動機**: 使用者回報「AI 分析與歷史報告」頁面功能不完善，且希望改善全站的導覽列使用體驗，讓當前頁面按鈕能自動置中。
- **核心變更**:
    - **完善 AI 分析與歷史報告功能 (頁面四)**:
        - **根本問題修復**: 修正了先前版本中，AI 生成的精美 HTML 報告無法被正確檢視的嚴重問題。現在，「查看報告」按鈕會直接開啟由 AI 生成的、位於 `/reports` 目錄下的獨立報告頁面，而不是連結到一個只能顯示原始資料的舊版檢視器。
        - **全生命週期管理**: 重構了 `page4_analyzer.html` 的前端邏輯。現在，檔案列表不再只顯示「可分析」的項目，而是會完整呈現所有處於 `'processed'` (可供分析), `'analyzed'` (分析完成), 和 `'error'` (分析失敗) 狀態的檔案。
        - **增加互動性**: 根據檔案的不同狀態，為其提供了對應的操作按鈕，例如「重新分析」、「重試」和「查看錯誤」，並為不同狀態的檔案加上了彩色的標籤，大幅提升了介面的可操作性和清晰度。
        - **後端 API 增強**: 對應地修改了 `/api/analyzer/processed_files` 和 `/api/analyzer/reports` 兩個 API，使其能夠支援前端的全新功能需求。
    - **優化導覽列體驗 (全站)**:
        - 在所有核心功能頁面 (`page1` 至 `page7`) 中，新增了一段 JavaScript 程式碼。
        - 這段程式碼會在頁面載入時，自動將水平捲動的導覽列中「當前作用中」的按鈕，平滑地捲動到畫面的中央位置。
        - 此項改進徹底解決了在行動裝置或窄螢幕上，當前頁面按鈕可能隱藏在可視區域外的問題，顯著提升了導覽的易用性。
- **成果**: 此次更新一舉解決了 AI 分析流程的「最後一哩路」問題，並賦予了使用者完整的檔案生命週期管理能力，使頁面四的功能達到前所未有的完整高度。同時，全域性的導覽列優化也為所有使用者帶來了更流暢、更直觀的操作體驗。

---
## 1014號 - 2025-09-11T23:03:55.543128+08:00

### fix(ui): 修正頁面七導覽列與頁面四按鈕排版問題

- **動機**: 使用者回報，「提示詞管理」頁面 (頁面七) 的上方導覽列功能不完整且樣式不統一；同時，「AI 分析」頁面 (頁面四) 的部分控制按鈕排版錯亂，影響使用。
- **核心變更**:
    - **修正頁面七導覽列 (`page7_prompts.html`)**:
        - 將頁面中一個無法使用的模擬導覽列，替換為全站統一的標準導覽列元件。
        - 在頁面 `<head>` 中引入了標準的 `nav.css` 樣式表，確保了導覽列在功能和視覺上與其他所有頁面保持一致。
    - **修正頁面四按鈕排版 (`page4.css`)**:
        - 分析發現，問題源於一個過於通用的 `button { width: 100%; }` 樣式規則。
        - 將此規則的選擇器從通用的 `button`，修改為更具體的 ID 選擇器 `button#start-analysis-btn`。
        - 此項修改精準地將「全寬」樣式只應用於主操作按鈕，成功修復了「全選」和「取消全選」等按鈕的排版問題，使其恢復正常的並排顯示。
- **成果**: 兩項由先前重構所引入的 UI 問題都已成功解決。現在，所有頁面的導覽體驗保持一致，且頁面四的佈局已恢復正常，提升了應用的整體穩定性與易用性。

---
## 1013號 - 2025-09-11T22:30:37.151711+08:00

### refactor(core): 實作全新兩階段 AI 分析架構與介面

- **動機**: 既有的 AI 分析流程為單一、籠統的步驟，難以控制其準確性且不易維護。根據使用者提出的新策略藍圖，我們需要將其重構為一個更穩健、更可靠的「兩階段 AI 分析」架構（第一階段：偵察兵-資料提取；第二階段：財經編輯-報告生成），以明確劃分 AI 與本地程式碼的職責。同時，既有的 AI 分析頁面和提示詞管理頁面也已不符合新架構的需求，需要全面更新以提升使用者體驗。

- **核心變更**:
    - **兩階段提示詞管理 (頁面七)**:
        - 使用者提供了全新的、基於 Tailwind CSS 的 HTML 模板，我用其完全覆寫了 `src/static/page7_prompts.html`，建立了一個專門用於管理兩階段提示詞的現代化介面。
        - 我對後端進行了配套改造，大幅簡化了 `src/core/prompt_manager.py` 和對應的 API 路由 `src/api/routes/page7_prompts.py`，使其能精準地讀取和儲存新的兩階段提示詞結構。
    - **AI 分析頁面重構 (頁面四)**:
        - 根據使用者的明確指示，我參照頁面二（批次下載）的成功設計，完全重構了 `src/static/page4_analyzer.html`。
        - 新介面將原本的下拉選單，改為功能更強大的**帶勾選框的檔案表格**，並加入了「全選」功能。
        - 我還為其新增了與其他頁面完全一致的**即時 WebSocket 狀態日誌**，並附帶「複製日誌」按鈕，創造了無縫且一致的使用者體驗。
    - **後端 AI 流程重構 (核心)**:
        - **增強 `key_manager.py`**: 新增了 `get_all_valid_keys_for_manager()` 函式，使其能為 `GeminiManager` 提供初始化所需的完整金鑰列表。
        - **增強 `gemini_manager.py`**: 為了支援自訂提示詞，我新增了更通用的 `prompt_for_json()` 和 `prompt_for_text()` 方法，並讓其能根據需求回傳 JSON 或純文字，大幅提升了其靈活性。
        - **重寫核心任務 (`page4_analyzer.py`)**: 我徹底重寫了後端的 AI 分析背景任務，使其能夠：
            1.  接收並處理**多個檔案**的批次分析請求。
            2.  嚴格遵循新的**兩階段分析流程**：先用第一階段提示詞提取結構化資料，然後（在模擬的本地計算後）再用第二階段提示詞和所有數據生成最終的 HTML 報告。
            3.  在處理流程的每個關鍵步驟，都透過 WebSocket 向前端發送**即時進度更新**。
    - **資料庫遷移 (`database.py`)**:
        - 為了儲存第一階段 AI 提取出的成果，我在 `reports` 資料表中新增了一個 `structured_data` 欄位，並加入了安全的遷移邏輯。

- **成果**: 這次從前端到後端的大規模重構，成功地為專案建立了一個高度穩健、可維護且可擴充的全新 AI 分析架構。新的架構完美地實現了使用者「偵察兵」和「財經編輯」的策略構想，其清晰的職責劃分將能有效提升系統的可靠性。同時，煥然一新的前端介面也為使用者帶來了更流暢、更一致的操作體驗。

---
## 1012號 - 2025-09-11T19:20:52.733847+08:00

### feat(downloader): 依最終需求改造下載頁面UI與命名邏輯

- **動機**: 根據使用者最終、詳細的需求，對「批次下載」頁面的前端介面和後端檔案命名邏輯進行一次全面的升級與修正，以完全符合專案要求。
- **核心變更**:
    - **前端介面改造 (頁面二)**:
        - **API 增強**: `page2_downloader.py` 中的 `/pending_urls` API 現在會查詢並提供 `author`, `message_date`, `message_time` 等完整資訊。
        - **表格化 UI**: `page2_downloader.html` 的前端邏輯被完全重寫。現在它會將待下載項目渲染成一個與頁面一風格完全相同的表格，欄位包含「勾選框、日期、時間、作者、連結」，大幅提升了資訊的清晰度和操作的一致性。
        - **CSS 統一**: `page2.css` 已更新，確保新表格的樣式與全站統一。
    - **後端條件式命名**:
        - **新增工具**: 建立了 `src/core/filename_utils.py`，提供 `sanitize_for_filename` 函式，用於從作者名稱中移除特殊字元並用底線取代，以確保檔名安全。
        - **傳遞資料**: `page2_downloader.py` 中的 `run_download_task` 現在會從資料庫讀取 `author`, `message_date`, 和 `message_time`，並將其傳遞給核心下載工具。
        - **最終命名邏輯**: `drive_downloader.py` 中的 `download_file` 函式已更新為最終的條件式邏輯：
            - 如果 `message_date` 存在，則使用 LINE 訊息時間來產生 `[ID]_[淨化後作者]_[時間戳].副檔名` 格式的檔名。
            - 如果 `message_date` 不存在，則檔名中不包含時間戳，格式為 `[ID]_[淨化後作者].副檔名`。
- **成果**: 本次更新一舉完成了對下載功能的兩項重要改造。前端介面現在完全符合使用者對「頁面一」風格的期望，而後端命名邏輯在經過多次澄清後，也已精準實現了基於 LINE 訊息時間和作者的條件式命名，確保了系統的正確性與健壯性。

---
## 1011號 - 2025-09-11T16:32:04.227533+08:00

### feat(parser): 實作 LINE 聊天紀錄解析與前端表格呈現功能

- **動機**: 使用者希望能將一個僅能提取網址的簡單頁面，升級為一個能從 LINE 聊天紀錄中，智慧解析出「日期」、「時間」、「作者」和「連結」等結構化資訊，並以清晰、對行動裝置友善的表格呈現的完整功能。
- **核心變更**:
    - **後端解析邏輯 (`src/tools/url_extractor.py`)**:
        - **全新解析器**: 從頭撰寫了 `parse_chat_log` 函式，使用正規表示式來精準識別 LINE 的日期格式、發言人格式 (`時間\t作者`)，以及其後跟隨的網址。
        - **相容性處理**: 為了不破壞既有功能，舊的 `extract_urls` 函式被保留，但其內部邏輯改為呼叫新解析器，確保了系統在開發過程中的穩定。
    - **前端介面升級 (`src/static/page1_ingestion.html`)**:
        - **動態表格**: 新增了一個空的表格結構。使用 JavaScript，在 API 成功回傳資料後，動態地建立 `<tr>` 和 `<td>` 元素，將解析出的結構化資料填入表格中。
        - **使用者體驗優化**: 表格在沒有結果時會自動隱藏。連結會被截短顯示，但可以透過滑鼠懸浮看到完整網址，並可點擊在新分頁中開啟。
    - **響應式設計 (`src/static/css/page1.css`)**:
        - 為新表格新增了完整的 CSS 樣式，使其外觀與專案風格一致。
        - 關鍵性地使用了 `overflow-x: auto` 和 `white-space: nowrap` 屬性，讓表格在窄螢幕（如手機）上可以順暢地水平捲動，解決了內容可能溢出的問題。
    - **資料庫擴充與儲存 (`src/db/database.py`, `url_extractor.py`)**:
        - **綱要遷移**: 在資料庫初始化腳本中，為 `extracted_urls` 資料表新增了 `author`, `message_date`, `message_time` 三個欄位。
        - **儲存邏輯更新**: 重寫了 `save_urls_to_db` 函式，使其能夠接收新的結構化資料，並將作者、訊息日期和時間等完整資訊存入資料庫。
    - **環境與依賴修復**:
        - **`__init__.py`**: 為 `src/core`, `src/db`, `src/tools` 等目錄補上了 `__init__.py` 檔案，解決了 Python 套件的匯入問題。
        - **安裝依賴**: 透過分析 `requirements/*.txt`，補齊了專案執行所需的所有依賴項，如 `fastapi`, `uvicorn`, `psutil` 等，徹底解決了伺服器無法啟動的問題。
- **成果**: 本次更新成功交付了一個從後端解析、資料庫儲存到前端呈現的完整功能。使用者現在擁有一個強大且易於使用的工具，可以快速地將混亂的聊天紀錄轉換為結構清晰、可操作的資訊表格，大幅提升了工作效率。

---
## 1010號 - 2025-09-11T12:22:07.194382+08:00

### feat(ui): 全面 UI/UX 改造，提升響應式設計與易用性

- **動機**: 使用者反應應用程式的導覽列在行動裝置上過於擁擠，且新建立的金鑰和提示詞管理頁面排版不佳，辨識度低，需要在不同尺寸的裝置上（特別是手機和平板）有更好的體驗。
- **核心變更**:
    - **主導覽列改造 (`src/static/css/nav.css`)**:
        - **水平捲動**: 放棄了舊的 flexbox 換行佈局，將導覽列改為 `overflow-x: auto` 的水平捲動容器。這確保了即使未來有更多頁面，導覽列在手機上也不會擠壓變形。
        - **按鈕式設計**: 將 `<a>` 連結的樣式修改為更清晰、帶有圓角的方形按鈕，並增加了間距和 hover 效果，提升了視覺質感和點擊體驗。
        - **捲軸美化**: 為 Webkit 核心的瀏覽器新增了捲軸樣式，使其更纖細、更融入整體設計。
    - **提示詞管理頁面改造 (`page7`)**:
        - **卡片式佈局**: 在 `page7_prompts.html` 中，將原本單調的 `<ul>` 列表，改為由 JavaScript 動態生成的、更具現代感的「卡片式」網格佈局 (`prompt-grid`)。
        - **資訊摘要**: 每張卡片現在都會顯示提示詞的鍵名 (Title) 和其內容的描述 (Description)，讓使用者能快速識別每個提示詞的用途。
        - **響應式網格**: 在 `page7.css` 中，使用 `display: grid` 和 `grid-template-columns: repeat(auto-fill, minmax(250px, 1fr))`，讓卡片網格能根據螢幕寬度自動調整每行的卡片數量，完美適應從手機到桌面的螢幕。
    - **金鑰管理頁面改造 (`page6`)**:
        - **解決溢出問題**: 在 `page6.css` 中，針對 `.key-item` 列表項新增了 `@media (max-width: 768px)` 媒體查詢。
        - **垂直堆疊**: 在窄螢幕上，原本水平排列的金鑰名稱、雜湊值、狀態等資訊，會自動變為垂直堆疊，確保所有內容都能完整顯示而不會超出邊框。
        - **細節優化**: 調整了間距和對齊方式，使行動裝置上的版面更加清晰易讀。
- **成果**: 本次更新顯著提升了應用程式的整體使用者體驗和視覺品質。新的導覽列和卡片式佈局不僅更美觀，也透過響應式設計徹底解決了在行動裝置上的可用性問題，讓應用在各種裝置上都有一致且專業的表現。

---
## 1009號 - 2025-09-11T11:20:20.947278+08:00

### refactor(core): 架構重構與錯誤修復

- **動機**: 根據使用者的進階需求，將原本分散在各頁面的金鑰輸入和提示詞選擇功能，重構為獨立、集中的管理頁面，以提升應用的模組化程度、可維護性和擴充性。同時，修復在此過程中發現的數個啟動時的嚴重錯誤。
- **核心變更**:
    - **架構重構 - 模組化**:
        - **金鑰管理器 (`src/core/key_manager.py`)**: 建立了一個新的核心模組，專門處理 API 金鑰的儲存 (於 `src/db/secrets/keys.json`)、讀取、雜湊、驗證和輪詢。
        - **提示詞管理器 (`src/core/prompt_manager.py`)**: 建立了一個新的核心模組，提供對 `prompts.json` 檔案的完整 CRUD 操作。
        - **新增 API 路由**: 為上述兩個新模組建立了對應的 FastAPI 路由 (`page6_keys.py`, `page7_prompts.py`)。
    - **架構重構 - 前端**:
        - **金鑰管理頁面 (`src/static/page6_keys.html`)**: 建立了一個全新的獨立頁面，用於管理金鑰池。
        - **提示詞管理頁面 (`src/static/page7_prompts.html`)**: 建立了一個全新的獨立頁面，用於管理提示詞。
        - **AI 分析頁面 (`page4_analyzer.html`)**: 移除了原有的金鑰輸入框，改為提供指向新管理頁面的連結。
        - **全域導覽列更新**: 在所有頁面的導覽列中新增了指向新頁面的連結。
    - **錯誤修復**:
        - **`key_manager.py`**: 新增了遺失的 `from datetime import datetime` 匯入。
        - **`prompt_manager.py`**: 新增了遺失的 `from typing import Optional` 匯入，修正了導致伺服器啟動失敗的 `NameError`。
        - **`tests/test_core.py`**: 修正了測試案例中對 naive datetime 處理的邏輯，使其更準確。
- **成果**: 此次提交不僅完成了一次大規模的架構重構，將應用程式的核心設定功能模組化和獨立化，還修復了多個先前版本中潛藏的、會導致啟動失敗的嚴重錯誤。目前的版本在架構上更清晰、功能上更完整，且經過測試驗證，更加穩健可靠。

---
## 1008號 - 2025-09-11T10:54:41.438759+08:00

### refactor(core): 架構重構，建立獨立的金鑰與提示詞管理功能

- **動機**: 根據使用者的進階需求，將原本分散在各頁面的金鑰輸入和提示詞選擇功能，重構為獨立、集中的管理頁面，以提升應用的模組化程度、可維護性和擴充性。
- **核心變更**:
    - **後端模組化**:
        - **金鑰管理器 (`src/core/key_manager.py`)**: 建立了一個新的核心模組，專門處理 API 金鑰的儲存 (於 `src/db/secrets/keys.json`)、讀取、雜湊、驗證和輪詢。這為後續實現金鑰池和速率限制等高階功能打下了基礎。
        - **提示詞管理器 (`src/core/prompt_manager.py`)**: 建立了一個新的核心模組，提供對 `prompts.json` 檔案的完整 CRUD (建立、讀取、更新、刪除) 操作，將提示詞的管理邏輯集中化。
        - **新增 API 路由**:
            - **`src/api/routes/page6_keys.py`**: 建立了全新的 API 路由，提供 `/keys` 和 `/keys/validate` 等端點，讓前端可以管理金鑰池。
            - **`src/api/routes/page7_prompts.py`**: 建立了全新的 API 路由，提供 `/prompts` 端點，讓前端可以管理提示詞。
    - **前端頁面建立**:
        - **金鑰管理頁面 (`src/static/page6_keys.html`)**: 建立了一個全新的獨立頁面，使用者可以在此處新增、刪除、查看和重新驗證金鑰池中的所有金鑰，並有清晰的狀態顯示。
        - **提示詞管理頁面 (`src/static/page7_prompts.html`)**: 建立了一個全新的獨立頁面，提供一個主從式介面，讓使用者可以方便地查看、新增、編輯和刪除所有提示詞。
    - **既有功能改造與整合**:
        - **AI 分析頁面 (`page4_analyzer.html`)**: 移除了原有的金鑰輸入框，改為提供兩個指向新管理頁面的連結按鈕。其後端邏輯也同步更新，現在會自動從 `key_manager` 中獲取有效金鑰來執行分析，無需前端傳遞。
        - **全域導覽列更新**: 在 `api_server.py` 和 `ui.py` 中註冊了所有新路由，並更新了所有頁面 (`page1` 到 `page7`) 的導覽列，確保新功能被無縫整合進現有應用程式中。
- **成果**: 此次大規模的架構重構，成功地將應用程式的核心設定功能（金鑰和提示詞管理）模組化和獨立化。這不僅大幅提升了程式碼的清晰度和可維護性，也為未來實現更複雜的金鑰管理策略（如金鑰池輪詢、速率限制）和更豐富的 AI 功能奠定了堅實的基礎，是專案邁向更專業、更穩健架構的關鍵一步。

---
## 1007號 - 2025-09-11T10:03:26.418459+08:00

### refactor(core): 建立中央時間模組並從源頭修正時間問題

- **動機**: 根據使用者的建議，目前的時區問題根源在於資料產生時（檔案命名、資料庫寫入）就使用了錯誤的 UTC 時間。為從根本上解決此問題，需要將時間處理邏輯集中化，並在資料建立的源頭就使用正確的時區。
- **核心變更**:
    - **建立中央時間模組 (`src/core/time_utils.py`)**:
        - 建立了一個新的 `time_utils.py` 模組，作為全專案獲取「亞洲/台北」時間的唯一、權威來源。
        - 該模組提供了 `get_current_taipei_time_iso()` 函式，用於產生標準化的 ISO 格式時間字串。
        - 同時新增了 `format_iso_for_filename()` 函式，專門用於將 ISO 時間字串安全地格式化為檔名。
    - **修正資料庫寫入源頭**:
        - **`src/tools/url_extractor.py`**: 修改了 `save_urls_to_db` 函式。現在，它會匯入並呼叫 `get_current_taipei_time_iso()`，確保所有新網址紀錄在存入資料庫時，其 `created_at` 欄位從一開始就是帶有正確時區的台北時間。
    - **修正檔名產生邏輯**:
        - **`src/tools/drive_downloader.py`**: 修改了 `download_file` 函式，使其不再自行解析時間字串，而是呼叫 `time_utils.format_iso_for_filename()` 來處理。這確保了檔名中的時間戳能正確地從帶有時區的資料庫時間轉換而來。
    - **新增 Pytest 測試**:
        - **`tests/test_core.py`**: 建立了一個新的測試檔案，專門用於測試核心模組。
        - 為新的 `time_utils` 模組撰寫了全面的單元測試，使用 `freezegun` 套件來固定時間，驗證了時區轉換和格式化在各種情況下的正確性。
        - 將 `freezegun` 和 `python-dateutil` 加入到 `requirements` 中。
- **成果**: 此次重構從根本上解決了系統的時間處理問題。所有新的時間戳現在都在資料產生的源頭被正確設定為台北時區，確保了整個系統資料流中時間的一致性與準確性。新增的自動化測試也為此核心功能的穩定性提供了保障。

---
## 1006號 - 2025-09-11T09:40:13.560789+08:00

### fix(ui): 修正前端時間戳的時區轉換問題

- **動機**: 使用者回報，在修復了時間格式後，前端顯示的時間戳雖然格式正確，但並未正確地從 UTC 轉換為「亞洲/台北」時區，導致顯示的時間與本地時間相差 8 小時。
- **核心變更**:
    - **`src/static/page2_downloader.html` & `src/static/page3_processor.html`**:
        - **重寫 `formatTaipeiTime` 函式**: 放棄了之前手動拼接時間字串的方式，改為使用瀏覽器內建的、更為可靠的 `Intl.DateTimeFormat` API。
        - **確保時區轉換**: 新的函式明確指定 `timeZone: 'Asia/Taipei'`，確保任何從後端傳入的、符合 ISO 8601 格式的時間字串（通常為 UTC），都能被正確地轉換為台北本地時間後再進行格式化。
        - **格式化技巧**: 巧妙地利用 `en-CA` locale 來產生 `YYYY-MM-DD` 格式，再透過字串取代，最終組合成使用者期望的 `YYYY/MM/DD HH:mm:ss` 格式，避免了 `zh-TW` locale 可能產生的「上午/下午」等非預期文字。
- **成果**: 徹底解決了前端時間顯示的錯誤。現在，所有從後端獲取的時間戳都會被正確地轉換為台北時間（UTC+8）再顯示，確保了使用者介面上所有時間的準確性與一致性。

---
## 1005號 - 2025-09-11T08:31:46.162410+08:00

### feat(ui): 全面統一時間格式並改善使用者體驗

- **動機**: 使用者回報系統中的時間格式不一致，部分顯示為本地化的中文時間，部分為 ISO 格式，難以閱讀。同時，使用者希望能方便地複製狀態日誌，並改善已處理報告列表的排版。
- **核心變更**:
    - **時間格式統一 (後端)**:
        - **`src/api/api_server.py`**: 修改了 `logging.basicConfig`，新增 `datefmt='%Y-%m-%dT%H:%M:%S%z'` 參數。這確保了所有後端日誌（無論是在主控台還是資料庫中）都使用標準化的、包含時區的 ISO 8601 格式，例如 `2025-09-11T08:30:00+0800`，徹底解決了格式不一致的問題。
    - **時間格式統一 (前端)**:
        - **`src/static/page2_downloader.html`**: 新增了 `formatTaipeiTime` JavaScript 函式，用於將從 API 收到的 ISO 時間字串，格式化為 `YYYY/MM/DD HH:mm:ss` 的可讀格式。
        - **`src/static/page2_downloader.html` & `src/static/page3_processor.html`**: 將前端所有動態產生的時間戳（包括「已完成下載」列表和「狀態日誌」）都改為使用新的 `formatTaipeiTime` 函式，確保了前端顯示的絕對一致性。
    - **新增日誌複製功能**:
        - **`page2.html` & `page3.html`**: 在「狀態日誌」的標題旁新增了一個「📄」複製按鈕。
        - **JavaScript**: 為按鈕新增了事件監聽器。點擊後，會將完整的日誌內容複製到使用者的剪貼簿，並將按鈕圖示變為「✅」持續 3 秒，為使用者提供清晰的視覺回饋。
        - **`src/static/css/common.css`**: 建立了一個新的共用 CSS 檔案，用於美化複製按鈕和相關的標題排版，並在 `page2.html` 和 `page3.html` 中引入。
    - **已處理報告列表排版優化**:
        - **`src/static/page3_processor.html`**: 修改了 `fetchAndRenderProcessedFiles` 函式中的 HTML 生成邏輯，為每個列表項使用了更具結構的 `<li>` 和 `<span>` 標籤。
        - **`src/static/css/page3.css`**: 為新的 HTML 結構添加了 Flexbox 樣式，使檔名和「查看報告」按鈕能在同一行內完美對齊，解決了先前版本中排版混亂的問題。
- **成果**:
    1.  **時間完全統一**: 從後端日誌到前端顯示，所有時間都統一為基於「亞洲/台北」時區的標準化格式，提升了可讀性和專業性。
    2.  **操作更便利**: 使用者現在可以一鍵複製所有狀態日誌，方便問題回報與記錄。
    3.  **視覺更清晰**: 「已處理報告」列表的排版變得整齊美觀，提升了整體的 UI 品質。

---
## 1004號 - 2025-09-11T02:22:31.369067+08:00

### feat(core): 完成報告文字提取與顯示功能

- **動機**: 使用者回報報告檢視器中雖然能看到圖片，但無法顯示從文件中提取的文字。經查，這是因為後端雖然有提取圖片的邏輯，但從未實作文字的提取、儲存與API服務。
- **核心變更**:
    - **資料庫升級 (`src/db/database.py`)**:
        - 在 `extracted_urls` 資料表中新增了 `extracted_text` 欄位 (TEXT type)，用於儲存文件文字內容。
        - 更新了資料庫遷移邏輯，以確保舊資料庫也能平滑升級。
    - **內容提取器增強 (`src/tools/content_extractor.py`)**:
        - 全面重構了 `extract_from_pdf`, `extract_from_docx`, `extract_from_pptx` 等函式。
        - 現在這些函式在提取圖片的同時，也會使用對應的函式庫 (`PyMuPDF`, `python-docx`) 來提取文件中的所有文字內容。
    - **處理流程更新 (`src/api/routes/page3_processor.py`)**:
        - 修改了 `run_processing_task` 背景任務，使其在呼叫 `extract_content` 後，會將回傳的文字儲存到資料庫新增的 `extracted_text` 欄位中。
    - **API 功能補齊 (`src/api/routes/page3_processor.py`)**:
        - 修改了 `get_report_content` API，使其從資料庫中讀取已儲存的 `extracted_text` 內容，並透過 API 回傳給前端，取代了之前的靜態預留位置文字。
    - **測試驗證**:
        - 擴充了 `tests/test_integration.py` 中的整合測試，新增了斷言來驗證文字內容是否被成功提取並儲存到資料庫中。
- **成果**: 成功地為檔案處理流程補齊了文字提取的功能。現在，使用者在檢視報告時，不僅能看到圖片，還能看到從原始文件中完整提取的文字內容，完善了核心功能閉環。

---
## 1003號 - 2025-09-11T02:04:14.841857+08:00

### fix(core): 全面修復檔案處理流程並建立測試套件

- **動機**:
    1. 使用者回報「報告檢視器」頁面因 API 路徑錯誤 (404) 而無法載入內容。
    2. 後續追查發現，檔案下載後沒有副檔名，導致內容提取失敗，預覽內容為空。
    3. 使用者要求統一檔案命名規則，加入台北時區的時間戳以便追蹤。
    4. 專案缺乏測試，無法保障後端穩定性。
- **核心變更**:
    - **API 路徑修正**:
        - 修正了 `src/static/report_viewer.html`，將 JavaScript 中的 API 呼叫路徑更正為正確的 `/api/processor/report/{id}`。
    - **智慧化下載器 (`src/tools/drive_downloader.py`)**:
        - 修改了 `download_file` 函式，使其接受 `url_id` 和 `created_at` 參數，以建立統一且可追溯的檔名。
        - 引入 `filetype` 函式庫，透過分析檔案內容來強制偵測並賦予正確的副檔名，解決了 `gdown` 無法處理部分 Google Drive 連結的問題。
        - 檔名現在會根據資料庫中的建立時間 (`created_at`) 和 ID 統一格式化為 `YYYY-MM-DDTHH-MM-SS_file_{id}.ext`。
    - **下載流程修改 (`src/api/routes/page2_downloader.py`)**:
        - 修改了 `run_download_task` 背景任務，使其在呼叫 `download_file` 時，能從資料庫中讀取並傳入 `url_id` 和 `created_at`。
    - **建立完整測試套件**:
        - 從頭建立了 `tests/` 目錄與 `pytest` 環境。
        - 在 `requirements/core.txt` 和 `requirements/test.txt` 中補齊了所有依賴。
        - 重構了資料庫模組 (`src/db/database.py`)，使其可以透過環境變數支援隔離的測試資料庫。
        - 撰寫了單元測試 (`test_tools.py`)，並在此過程中發現並修復了 `image_compressor.py` 的一個錯誤。
        - 撰寫了整合測試 (`test_integration.py`)，涵蓋了對 DOCX/PDF 處理、以及新的下載器命名邏輯的驗證。
- **成果**:
    1. 徹底解決了報告無法預覽的問題，從下載、命名、處理到 API 呼叫形成了一個完整的閉環。
    2. 所有下載的檔案現在都有了統一、帶有時間戳的檔名，且副檔名保證正確。
    3. 為專案建立了一套高品質的自動化測試套件，極大地提升了程式碼的穩定性和未來的可維護性。

---
## 1002號 - 2025-09-11T01:25:21.361446+08:00

### feat(downloader): 智慧化檔案下載並統一檔名格式

- **動機**: 使用者反應，經過處理的報告預覽失敗。經查，原因是從 Google Drive 下載的檔案沒有副檔名，導致後續的內容提取工具無法識別檔案類型而跳過處理。此外，使用者希望能用統一的、包含時間戳的格式來命名下載的檔案，以便追蹤。
- **核心變更**:
    - **智慧化下載器 (`src/tools/drive_downloader.py`)**:
        - **移除檔名依賴**: 修改了 `download_file` 函式，使其不再依賴呼叫端傳入的、不含副檔名的檔名 (`download_1`)。
        - **自動偵測檔名**: 新的邏輯會讓 `gdown` 函式庫自動從網路回應中偵測原始檔名和副檔名。
        - **統一時間戳命名**: 在成功下載後，程式會自動以 `YYYY-MM-DDTHH-MM-SS_原始檔名.副檔名` 的格式重新命名檔案，並確保時間為「亞洲/台北」時區。為此新增了 `pytz` 作為核心依賴。
    - **擴充整合測試 (`tests/test_integration.py`)**:
        - 新增了 `test_drive_downloader_renaming` 測試案例。
        - 此測試透過模擬 `gdown` 的行為，專門驗證新的下載器邏輯是否能正確地為檔案加上時間戳並重新命名，確保了此功能的穩定性。
- **成果**: 現在，所有從 Google Drive 下載的檔案都會被自動賦予正確的副檔名和一個包含台北時間的時間戳，例如 `2025-09-11T01-25-21_my-document.pdf`。這從根本上解決了內容提取失敗的問題，並滿足了使用者對檔案命名統一性的要求。

---
## 1001號 - 2025-09-11T00:49:26.993621+08:00

### fix(api): 修正報告檢視器的 404 錯誤並建立測試套件

- **動機**: 使用者回報，在「檔案處理」頁面點擊「查看報告」時，報告內容無法載入，後端日誌顯示 `GET /api/report/{id} 404 Not Found` 錯誤。此外，專案缺乏測試來保障後端工具鏈的穩定性。
- **核心變更**:
    - **API 路徑修正**:
        - **問題分析**: 根本原因為前端呼叫的 API 路徑 (`/api/report/{id}`) 與後端因路由前綴 (`/api/processor`) 而實際提供的路徑 (`/api/processor/report/{id}`) 不匹配。
        - **程式碼修復**: 修改了 `src/static/report_viewer.html`，將 JavaScript 中的 `fetch` 呼叫更正為正確的 API 路徑，徹底解決 404 錯誤。
    - **建立測試框架**:
        - 從頭建立了 `tests/` 目錄，設定了 `pytest.ini`，並在 `requirements/test.txt` 中補齊了所有測試與核心模組所需的依賴（如 `pytest`, `python-pptx`, `requests`, `fastapi`, `Jinja2` 等）。
    - **強化後端工具與測試**:
        - **單元測試**: 撰寫了 `tests/test_tools.py`，透過模擬 DOCX 檔案驗證了 `content_extractor` 和 `image_compressor` 的核心邏輯。
        - **工具強化**: 測試過程中發現 `image_compressor.py` 在處理小檔案時會讓檔案變大。已修復此問題，使其在無法有效壓縮時，直接複製原檔，確保檔案大小不會增加。
        - **整合測試**: 撰寫了 `tests/test_integration.py`，該測試會動態建立 DOCX 和 PDF 檔案，並透過一個獨立的暫存資料庫，完整驗證 `run_processing_task` 函式對真實檔案的處理流程。
        - **資料庫可測試性重構**: 重構了 `src/db/database.py` 中的 `initialize_database` 與 `get_db_connection` 函式，使其能透過環境變數在測試模式下使用獨立的資料庫，從而讓整合測試可以在一個隔離的環境中進行。
- **成果**: 此次更新不僅從根本上解決了前端的 404 錯誤，更重要的是為專案建立了一套涵蓋單元測試與整合測試的完整測試套件。這套測試未來將能有效保障後端工具的穩定性與可靠性，大幅提升了專案品質。

---
## 1000號 - 2025-09-11T00:06:09.771284+08:00

### feat(ui): 新增已完成項目列表與報告檢視器

- **動機**: 使用者希望能更優雅地追蹤已完成的下載和處理任務，並能方便地查看處理後的結果，而不是僅在日誌中看到狀態更新。
- **核心變更**:
    - **頁面二 (批次下載) 增強**:
        - **後端**: 在 `page2_downloader.py` 中新增 `/api/downloader/completed` 端點，用於提供已下載完成的檔案列表。
        - **前端**: 在 `page2_downloader.html` 中新增「已完成下載」區塊，非同步載入並顯示檔名與完成時間。
    - **頁面三 (檔案處理) 增強**:
        - **後端**: 在 `page3_processor.py` 中新增 `/api/processor/processed` 端點，提供已處理完畢的檔案列表。
        - **前端**: 在 `page3_processor.html` 中新增「已處理報告」區塊，顯示檔名並提供一個「查看報告」按鈕，該按鈕會連結到新的報告檢視頁面。
    - **全新報告檢視器功能**:
        - **圖片壓縮工具**: 建立了新的 `src/tools/image_compressor.py` 工具，使用 Pillow 函式庫對圖片進行壓縮，以優化載入速度。
        - **報告內容 API**: 在 `page3_processor.py` 中新增 `/api/report/{id}` 端點。此 API 會獲取報告資料，呼叫壓縮工具處理圖片，並回傳文字內容和壓縮後圖片的 Web 路徑。
        - **報告檢視頁面**:
            - 建立了全新的 `src/static/report_viewer.html` 頁面範本。
            - 在 `src/api/routes/ui.py` 中新增 `/report/{id}` 路由來提供此頁面。
            - 頁面前端透過 JavaScript 呼叫內容 API，並將結果動態呈現在頁面上。
    - **靜態檔案服務**:
        - 修改了 `src/api/api_server.py`，將 `downloads` 目錄掛載為靜態資源目錄，確保前端可以成功載入壓縮後的圖片。
- **成果**: 此次更新大幅改善了使用者體驗。使用者現在可以在下載和處理頁面清晰地看到已完成的項目。更重要的是，提供了一個全新的報告檢視器，讓使用者可以直觀地查看處理後的圖片與文字結果，形成了一個完整、閉環的操作流程。

---
## 999號 - 2025-09-10T23:20:55.367522+08:00

### fix(core): 修正背景任務無法回報完成狀態的通訊問題

- **動機**: 使用者回報，在「批次下載」和「檔案處理」頁面，背景任務執行完畢後，前端介面沒有收到任何更新，導致列表狀態永遠停留在處理中。根本原因為背景任務向主伺服器回報狀態時，使用了由 `request.url.port` 獲取的錯誤埠號，導致 HTTP 請求失敗。
- **核心變更**:
    - **`src/api/api_server.py`**:
        - 新增了一個 FastAPI 中介軟體 (Middleware)。此中介軟體會在應用程式首次啟動時，從 ASGI Scope 中可靠地捕獲伺服器真實監聽的埠號，並將其儲存於全域的 `app.state.server_port` 變數中。
    - **`src/api/routes/page2_downloader.py`**:
        - 修改了 `start_downloads` 函式，將其獲取埠號的方式從不穩定的 `request.url.port` 變更為從 `request.app.state.server_port` 讀取。
    - **`src/api/routes/page3_processor.py`**:
        - 在 `start_processing` 函式中做了完全相同的修改，確保檔案處理任務也能使用正確的埠號。
- **成果**: 此項修復從根本上解決了背景任務與主伺服器之間的通訊障礙。現在，所有背景任務都能使用正確的埠號成功回報其最終狀態，確保了前端介面能夠即時、可靠地接收到 `PROCESSING_COMPLETE` 和 `DOWNLOAD_COMPLETE` 等通知，恢復了相關功能的狀態更新與可用性。

---
## 998號 - 2025-09-10T23:04:47.818197+08:00

### feat(ui): 優化檔案處理完成的狀態通知

- **動機**: 使用者回報，在「檔案處理」頁面，當一個或多個檔案處理完成後，前端介面沒有提供足夠清晰的、可供識別的成功或失敗紀錄。先前的日誌訊息只顯示內部任務 ID (`檔案 #1`)，對使用者沒有實質幫助。
- **核心變更**:
    - **後端增強 (`src/api/routes/page3_processor.py`)**:
        - 修改了 `run_processing_task` 背景任務。在任務完成並建構通知 `payload` 時，將處理中檔案的實際**檔名** (`file_path.name`) 也一併加入到 `payload` 中。
    - **前端強化 (`src/static/page3_processor.html`)**:
        - 重寫了處理 `PROCESSING_COMPLETE` WebSocket 訊息的 JavaScript 邏輯。
        - **顯示檔名**: 新的邏輯會從 `payload` 中讀取檔名，並產生包含具體檔名的日誌訊息，例如 `✅ [處理成功] 檔案 'my-document.docx' 已處理完畢。`
        - **顯示詳細錯誤**: 在處理失敗的情況下，程式碼現在會嘗試從 `payload` 的 `result` 欄位中解析後端傳來的具體錯誤原因，並將其顯示給使用者，例如 `❌ [處理失敗] 檔案 'another-file.pdf' 處理失敗：檔案格式不支援。`
- **成果**: 此項改進顯著提升了使用者體驗。現在，當檔案處理任務結束時，使用者可以在狀態日誌中看到一個清晰、具體且有意義的紀錄，明確知道是**哪個檔案**成功或失敗，以及**失敗的原因**，從而解決了先前版本中回饋模糊的問題。

---
## 997號 - 2025-09-10T21:09:57.207472+08:00

### refactor(core): 為背景任務建立 WebSocket 通知機制

- **動機**: 使用者回報，在「批次下載」和「檔案處理」頁面，背景任務（如下載、處理）完成後，前端介面沒有任何反應，導致使用者體驗不佳。列表不會自動更新，使用者也不知道任務是否成功。
- **核心變更**:
    - **新增內部通知 API**:
        - **`api_server.py`**: 增強了 `/api/internal/notify_task_update` 端點，使其能夠根據背景任務傳來的 `task_type` (`download`, `processing` 等)，產生對應的 WebSocket 訊息類型 (`DOWNLOAD_COMPLETE`, `PROCESSING_COMPLETE`)。
    - **改造背景任務**:
        - **`page2_downloader.py`**: 修改了 `run_download_task` 背景任務。在任務結束時（無論成功或失敗），都會向內部通知 API 發起一個 HTTP 請求，以觸發 WebSocket 廣播。同時，將主 API 伺服器的埠號從 API 層傳遞到背景任務中。
        - **`page3_processor.py`**: 對 `run_processing_task` 做了完全相同的改造。
    - **強化前端監聽器**:
        - **`page2_downloader.html`**: 新增了對 `DOWNLOAD_COMPLETE` 訊息的監聽，收到後會自動刷新待下載列表。
        - **`page3_processor.html`**: 增強了對 `PROCESSING_COMPLETE` の處理邏輯，現在會根據任務成功或失敗，在日誌中顯示更清晰的提示訊息，並解釋為何項目會從列表中移除。
- **成果**: 此架構性重構建立了一個可靠的、由背景任務到前端的通知鏈。現在，所有背景任務完成後都能即時、可靠地更新前端介面，大幅改善了應用的響應能力與使用者體驗。

---
## 996號 - 2025-09-10T20:56:59.615708+08:00

### fix(api): 修復檔案處理請求的 404 Not Found 錯誤

- **動機**: 使用者回報，在「檔案處理」頁面點擊「開始處理選中項目」時，前端會顯示「請求失敗：Not Found」錯誤，導致功能無法使用。
- **核心變更**:
    - **問題分析**: 經調查，前端正確地向 `/api/processor/start_processing` 發起 POST 請求。然而，在後端 `src/api/routes/page3_processor.py` 中，對應的路由被錯誤地定義為 `@router.post("/api/start_processing")`。由於該路由模組已在 `api_server.py` 中被加上了 `/api/processor` 的前綴，這導致實際的端點路徑變成了錯誤的 `/api/processor/api/start_processing`。
    - **程式碼修復**:
        - **`src/api/routes/page3_processor.py`**: 將錯誤的路由定義從 `@router.post("/api/start_processing")` 修正為 `@router.post("/start_processing")`，移除了多餘的 `/api` 前綴。
- **成果**: 此次修復使後端 API 路由與前端的呼叫完全對齊，徹底解決了 404 錯誤，恢復了檔案處理功能。

---
## 995號 - 2025-09-10T20:53:58.115261+08:00

### feat(ui): 將狀態日誌改為白底黑字淺色主題

- **動機**: 使用者回饋，在「批次下載」和「檔案處理」頁面中，深色的日誌區域（黑底白字）觀看效果不佳，希望改成類似 Gemini 淺色模式的白底黑字主題，以提升可讀性。
- **核心變更**:
    - **CSS 樣式調整**:
        - **`src/static/css/page2.css`**: 修改了 `#status-area` 的 CSS 規則，將 `background` 屬性改為 `#ffffff` (白色)，`color` 屬性改為 `#000000` (黑色)。
        - **`src/static/css/page3.css`**: 做了完全相同的修改，確保「檔案處理」頁面的日誌外觀與「批次下載」頁面保持一致。
- **成果**: 兩個功能頁面的狀態日誌現在都採用了清晰的白底黑字主題，符合使用者的要求，改善了日誌的可視性與整體介面的一致性。

---
## 994號 - 2025-09-10T20:19:40.095670+08:00

### fix(ui): 將固定導覽列改為靜態佈局以避免遮擋內容

- **動機**: 使用者回饋，先前實作的固定式 (`position: fixed`) 頂部導覽列雖然方便，但會遮擋下方頁面的頂部內容，影響使用。因此，需要將其改為隨頁面滾動的標準靜態布局。
- **核心變更**:
    - **CSS 調整 (`src/static/css/nav.css`)**:
        - 從 `.top-nav` class 中移除了 `position: fixed` 以及所有相關的定位屬性 (`top`, `left`, `width`, `z-index`)。
        - 刪除了先前為了解決遮擋問題而為 `body` 標籤設定的 `padding-top: 50px` 規則。
- **成果**: 頂部導覽列現在是一個正常的靜態元素，會隨著頁面內容一起向上滾動，不再覆蓋任何功能區塊，完全符合使用者的最新要求，提升了頁面的可用性。

---
## 993號 - 2025-09-10T20:05:11.783541+08:00

### fix(ui): 修復導覽錯誤並調整介面文字

- **動機**: 使用者回報，從主頁點擊「文件分析儀」時會發生「Internal Server Error」。同時，使用者要求進一步簡化介面，統一用詞並移除多餘的 UI 元素。
- **核心變更**:
    - **錯誤修復**:
        - **定位問題**: 經調查，錯誤的根源在於 `main.html` 中的「文件分析儀」按鈕，其連結指向一個在先前重構中已被刪除的 `/menu` 頁面。
        - **解決方案**: 將該按鈕的 `href` 屬性從 `/menu` 修正為文件分析儀模組的正確入口頁面 `/page1`，徹底解決了 500 伺服器錯誤。
    - **介面調整**:
        - **統一用詞**: 為了保持品牌一致性，將主頁 (`main.html`) 和所有五個功能頁面導覽列中的「鳳凰指揮中心」和「鳳凰首頁」等文字，統一為「鳳凰主頁」。
        - **簡化主頁**: 移除了 `main.html` 頁面右上角已無實際功能的漢堡選單圖示及其相關的 JavaScript，使主頁介面更加乾淨。
- **成果**: 此次更新不僅修復了一個導致核心功能無法訪問的嚴重錯誤，還根據使用者的回饋進一步提升了 UI 的簡潔度和一致性，改善了整體使用者體驗。

---
## 992號 - 2025-09-10T19:56:48.000720+08:00

### refactor(ui): 重構為固定的頂部水平導覽列

- **動機**: 先前的導覽設計（包括靜態頁首和可收合側邊欄）未能滿足使用者對極致簡潔與直接操作的期望。根據最新指示，需要再次重構，實作一個固定在頁面頂部、在所有功能頁間共享的水平導覽列。
- **核心變更**:
    - **工作區重置**: 為確保從一個乾淨的狀態開始，使用 `reset_all` 指令撤銷了所有關於「側邊欄」的修改，回到上一個穩定版本。
    - **新導覽列元件**:
        - **CSS**: 建立了一個新的共用樣式表 `src/static/css/nav.css`，用於定義一個深色的、固定在頂部的水平導覽列樣式，並包含了按鈕、懸停效果及當前頁面高亮的樣式。
        - **HTML**: 設計了一段標準的 `<nav>` HTML 結構，其中包含六個純文字按鈕，分別對應「鳳凰首頁」和五個功能頁面。
    - **統一頁面整合**:
        - **嵌入結構**: 逐一修改了所有五個功能頁面 (`page1.html` 到 `page5.html`)，將新的導覽列 HTML 結構直接嵌入到每個頁面的 `<body>` 頂部。
        - **統一外觀**: 每個頁面現在都引入了新的 `nav.css` 樣式表，確保了外觀的完全一致。
        - **簡化邏輯**: 為了高亮顯示當前頁面，直接在每個頁面對應的導覽連結上硬編碼了 `.active` class，移除了先前版本中動態載入和用 JavaScript 設定高亮的複雜性。
    - **檔案清理**: 刪除了因側邊欄設計而產生的、現已無用的 `menu.html` 和 `menu.css` 檔案，維持了專案的整潔。
- **成果**: 應用程式現在擁有一個極其簡單、清晰且一致的頂部導覽系統。使用者可以在任何功能頁面之間無縫切換，完全符合使用者對直接、無干擾操作流程的最終要求。

---
## 991號 - 2025-09-10T11:47:42.558872+08:00

### refactor(ui): 建立階層式導覽架構並統一功能頁面

- **動機**: 應用程式的主入口 (`/`) 未能正確導向至已實作的五個核心功能頁面，而是連結到一個已過時的佔位頁面。為解決此問題並實現使用者期望的「指揮中心 -> 功能分頁」的階層式導覽，需對前端導覽架構進行重構。
- **核心變更**:
    - **修改主頁入口 (`main.html`)**: 將「文件分析儀」按鈕的目標從舊的 `document_analyzer.html` 頁面更新為 `/page1`，使其成為文件分析子系統的正式入口。
    - **建立統一導覽列**: 設計並實作了一個全新的、固定在頁面頂部的導覽列。此導覽列包含返回「指揮中心」的連結，以及分別連向五個功能頁面（網址提取、批次下載、檔案處理、AI 分析、備份管理）的按鈕。
    - **應用導覽列**: 將此統一導覽列應用於所有五個功能頁面 (`page1_ingestion.html` 至 `page5_backup.html`)，並透過 `active` class 高亮顯示當前頁面，確保了子系統內部的導覽體驗高度一致。
    - **清理**: 刪除了已不再使用的佔位檔案 `src/static/document_analyzer.html`，維持了專案的整潔。
- **測試與驗證**: 建立了一個新的 Playwright 腳本，該腳本將自動化驗證完整的導覽流程，包括從主頁進入子系統、在子系統內各頁面間切換，以及返回主頁的功能，以確保所有連結均正確無誤。
- **成果**: 成功地將應用程式的前端重構為一個清晰的兩層式導覽架構。使用者現在可以從主指揮中心無縫進入文件分析系統，並在系統內的五個核心功能之間自由切換，大幅提升了應用的可用性與流程的連貫性。

---
## 990號 - 2025-09-10T01:17:39.797979+08:00

### feat(app): 建立文件分析儀 MPA 應用程式

- **動機**: 根據使用者的詳細需求，從頭開始建立一個功能完整的多頁應用程式（MPA），用於文件分析，並將其整合進現有的 FastAPI 專案框架中。
- **核心變更**:
    - **架構重構**:
        - 將原有的單體 `api_server.py` 重構為模組化的 `APIRouter` 架構。
        - 建立了一個專門的 `ui.py` 路由來統一管理所有 HTML 頁面的呈現。
        - 為每個核心功能（網址提取、下載、處理、AI分析、備份）建立了獨立的 API 路由檔案，大幅提升了程式碼的可維護性。
    - **功能實作 (共五大頁面)**:
        - **頁面一 (網址提取)**: 實作了前後端，允許使用者貼上文字、提取網址、存入資料庫，並提供查詢功能。
        - **頁面二 (批次下載)**: 實作了前後端，使用者可勾選網址，並透過背景任務進行下載。
        - **頁面三 (檔案處理)**: 實作了前後端，使用者可選擇已下載的檔案，並透過背景任務計算雜湊值、提取圖片。為此建立了 `file_hasher.py` 和 `content_extractor.py` 工具，並新增了 `python-docx`, `PyMuPDF`, `python-pptx` 依賴。
        - **頁面四 (AI 分析與歷史)**: 實作了最複雜的 AI 分析流程。
            - 建立了 `document_analyzer.py` 工具，用於分析文件文字與圖片。
            - 擴充了 `report_generator.py` 以生成 HTML 報告。
            - 在 `prompts.json` 中新增了對應的提示詞。
            - 建立了 `reports` 資料表來儲存歷史紀錄，並實作了歷史報告查看頁面。
        - **頁面五 (備份管理)**: 實作了觸發備份的前後端。建立了 `gdrive_backup.py` 工具來處理檔案壓縮，並為 Google Drive 上傳功能預留了介面。
    - **資料庫擴充**:
        - 大幅擴充了 `extracted_urls` 資料表，新增了 `status`, `local_path`, `file_hash` 等多個欄位來追蹤檔案的完整生命週期。
- **測試與驗證**:
    - **環境除錯**: 解決了數個因文件過時和依賴缺失導致的伺服器啟動錯誤。
    - **前端驗證**: 建立了 Playwright 測試腳本，自動化地訪問了所有新建的頁面，並驗證其標題是否正確，確保路由和頁面渲染正常。
- **成果**: 成功交付了一個功能完整、架構清晰、可擴充的文件分析 MPA。使用者現在擁有一個從 URL 輸入到最終報告產出、再到系統備份的完整工作流程。

---
## 989號 - 2025-09-09T23:39:41.289475+08:00

### chore(project): 全面清理專案檔案結構

- **動機**: 根據使用者指示，對專案進行深度清理，移除所有與主要執行無關的檔案、測試框架、快取以及執行時資料，以精簡專案結構。
- **核心變更**:
    - **第一輪清理 (通用清理)**:
        - 刪除了所有 `__pycache__` 目錄。
        - 刪除了多餘的 `package-lock.json`。
        - 刪除了資料庫檔案 `src/db/tasks.db` 以重設應用程式。
        - 刪除了 `docs/` 目錄下十數個過時的 Markdown 文件。
    - **第二輪清理 (深度清理)**:
        - 刪除了整個測試框架，包括 `src/tests` 目錄。
        - 刪除了所有與 Playwright 和 Node.js 測試環境相關的根目錄檔案 (`playwright.config.js`, `package.json`, `bun.lock`, `uv.lock`)。
        - 刪除了 `scripts/` 目錄下所有與測試相關的輔助腳本。
    - **第三輪清理 (精細清理)**:
        - 根據使用者最終確認，刪除了兩個非核心的輔助腳本 `scripts/ai.py` (備用啟動器) 和 `scripts/paper.py` (日誌報告工具)。
- **測試**: 每次刪除操作後，都使用 `ls` 或 `ls -R` 驗證檔案是否已確實移除。
- **成果**: 大幅精簡了專案的檔案數量，移除了完整的測試套件和多個輔助腳本，使專案結構更專注於核心的執行功能，顯著降低了複雜度。

---
## 988號 - 2025-09-09T22:36:42.463467+08:00

### docs(tools): 重寫工具說明文件以提升品質

- **動機**: 使用者指示，希望工具說明文件 (`TOOLS_README.md`) 的品質能像 `planv2.md` 一樣，具備更清晰的結構和更詳盡的內容，而不僅僅是 docstring 的簡單列表。
- **核心變更**:
    - **手動撰寫 `TOOLS_README.md`**: 放棄了原先由 `readme_tool.py` 自動生成的方式，改為手動撰寫一份高品質的說明文件。
    - **新文件結構**: 為每個工具設計了標準化的說明章節，包括「功能簡介」、「主要函式」、「使用方式」和「依賴性」，大幅提升了文件的可讀性和實用性。
    - **內容擴充**: 為 `src/tools` 目錄下的所有核心工具（如 `url_extractor.py`, `drive_downloader.py`, `pdf_parser.py` 等）都補充了詳細的功能描述和使用範例。
- **測試**: 透過 `read_file` 驗證了 `TOOLS_README.md` 的內容已成功更新為手動撰寫的高品質版本。
- **成果**: 產出了一份結構清晰、內容詳盡的 `TOOLS_README.md`，其品質看齊專案的架構文件，為開發者提供了極大的便利。

---
## 987號 - 2025-09-09T22:27:22.953597+08:00

### feat(core): 新增網址提取模組與工具文件產生器

- **動機**: 根據使用者需求，建立一個能從文字中提取網址並存入資料庫的功能模組。同時，建立一個能自動產生工具說明的工具。
- **核心變更**:
    - **資料庫擴充 (`src/db/database.py`)**: 新增了 `extracted_urls` 資料表，用於儲存提取出的網址。
    - **建立網址提取工具 (`src/tools/url_extractor.py`)**: 建立了一個新的獨立工具，能接收文字、提取網址，並將結果存入新的資料庫資料表中。
    - **API 整合 (`src/api/api_server.py`)**: 新增了 `/api/extract_urls` 端點，讓外部可以透過 API 呼叫網址提取功能。
    - **建立工具文件產生器 (`src/tools/readme_tool.py`)**: 建立了一個能掃描 `src/tools` 目錄並自動生成 `TOOLS_README.md` 文件的工具。為 `url_extractor.py` 加上了 docstring 作為示範。
- **測試**:
    - **單元測試**: 為 `url_extractor.py` 中的提取邏輯建立了新的單元測試 (`src/tests/test_url_extractor.py`)。
    - **整合測試**: 在 `src/tests/test_api_server.py` 中為新的 API 端點新增了整合測試。
    - **測試修正**: 新增了 `requirements/test.txt` 並安裝了 `httpx` 依賴，以修復測試環境問題。所有相關測試均已通過。
- **成果**: 成功交付了一個完整的網址提取功能模組，包含後端工具、API 端點和完整的測試。同時，交付了一個可擴充的工具文件自動化工具，提升了專案的可維護性。

---
## 986號 - 2025-09-09T21:33:43.601086+08:00

### refactor(core): 將獨立腳本重構為模組化工具

- **動機**: 為了提升程式碼的可維護性、可複用性和組織清晰度，需要將先前建立的 `standalone_pipeline.py` 整合式腳本，拆分為多個獨立的功能模組。
- **核心變更**:
    - **建立 `src/tools/` 模組**:
        - `drive_downloader.py`: 包含 `download_file` 函式，專責從 Google Drive 下載檔案。
        - `pdf_parser.py`: 包含 `parse_pdf` 函式，專責解析 PDF 內容與圖片。
        - `report_generator.py`: 包含 `setup_font` 和 `generate_final_report` 函式，專責處理字體與生成最終 PDF 報告。
        - `gemini_manager.py`: 包含 `ApiKey` 和 `GeminiManager` 類別，作為與 Google Gemini API 溝通的統一介面。
    - **建立 `scripts/run_processing_pipeline.py`**:
        - 建立了一個新的主執行腳本，它會從 `src/tools/` 中匯入上述模組，並調度它們以執行完整的端到端處理流程。
    - **清理**:
        - 成功拆分後，刪除了原有的 `standalone_pipeline.py` 檔案，避免程式碼重複。
- **測試**: 透過 `read_file` 驗證了所有新檔案的建立。此為純重構，未改變原有邏輯，因此未執行功能測試。
- **成果**: 成功將一個大型的單體腳本，重構成為一個結構清晰、各司其職的模組化系統。這大幅提升了程式碼的可讀性和未來的可擴充性，為後續開發工作打下了堅實的基礎。

---
## 985號 - 2025-09-09T21:24:11.691602+08:00

### feat(planning): 新增文件分析儀功能藍圖與佔位檔案

- **動機**: 根據使用者的指示，為專案規劃下一階段的核心功能：一個完整的文件分析與報告生成流程。
- **核心變更 (規劃與檔案建立)**:
    - **更新 `planv2.md`**:
        - 將使用者提供的詳細功能藍圖，正式增補至 `planv2.md` 文件中，作為新的「第六章：下一階段開發計畫：文件分析儀」。
        - 這份藍圖詳細定義了四個核心工具模組 (`drive_downloader`, `pdf_parser`, `report_generator`, `gemini_manager`)、資料庫升級方案，以及一個總指揮官腳本 `run_processing_pipeline.py`。
    - **建立 `standalone_pipeline.py`**:
        - 根據使用者提供的程式碼，建立了一個整合式的獨立執行腳本，用於快速展示與測試新功能的完整流程。
    - **建立前端佔位頁面與導航**:
        - 建立了 `src/static/document_analyzer.html` 作為新功能的前端入口頁面。
        - 更新了 `src/static/main.html`，在主頁上新增了指向「文件分析儀」的按鈕，使新功能融入現有的 MPA 導航架構。
- **測試**: 此為純文件更新與檔案建立任務，尚不涉及可執行的功能邏輯測試。
- **成果**: 為「文件分析儀」這個複雜的新功能奠定了清晰、完整的開發基礎。所有團隊成員（包括 AI 代理）現在對下一階段的目標、架構和模組劃分有了統一的認識。

---
## 984號 - 2025-09-09T21:04:12.586147+08:00

### chore(docs): 驗證並記錄 MPA 導航架構的實作狀態

- **動機**: 使用者要求實作 `planv2.md` 中描述的 MPA（多頁應用）導航流程，包含簡潔的主頁與功能頁的返回按鈕。在開始實作前，需先對現有程式碼進行徹底的分析。
- **核心變更 (分析與文件)**:
    - **程式碼驗證**:
        - 對 `src/static/main.html`、`src/static/mp3.html` 和 `src/api/api_server.py` 進行了詳細的程式碼審查。
        - **結論**: 審查發現，使用者所要求的功能**均已在目前的程式碼中完整實作**。`main.html` 已是簡潔的導航頁，`mp3.html` 已有返回按鈕，且後端路由設定正確。
    - **更新 `planv2.md`**:
        - 在架構文件中新增了「實施狀態」一節，明確記錄了本次的驗證結果，確認該計畫中的基礎導航部分已完成。
- **測試**: 此任務為純程式碼分析與文件更新，無須執行程式碼測試。透過 `read_file` 驗證了文件更新的正確性。
- **成果**: 避免了不必要的重複開發。透過更新 `planv2.md` 和 `Log.md`，確保了專案的官方文件與實際程式碼的狀態保持一致，為未來的開發者提供了清晰的現狀說明。

---
## 983號 - 2025-09-09T18:49:25.219454+08:00

### docs(architecture): 記錄 MPA 架構演進計畫

- **動機**: 根據與使用者的深入討論，為了確保未來的開發有清晰、一致的藍圖，需要將最終確定的 MPA（多頁應用程式）架構規劃正式文件化。
- **核心變更**:
    - **建立 `planv2.md`**:
        - 新增了一個 `planv2.md` 檔案，作為系統架構的官方演進計畫。
        - 文件中詳細分析了當前 SPA 架構的痛點（高耦合、難維護）。
        - 提出了新的「主頁-功能頁」(Hub-and-Spoke) MPA 架構，並繪製了簡化的架構圖來說明。
        - 詳細列出了實施新架構的具體步驟，包括建立 `main.html`、修改 `mp3.html` 以新增返回連結，以及更新後端路由。
        - 明確了未來新功能的擴充模式。
- **測試**: 此為純文件建立任務，不涉及程式碼變更，故無須測試。
- **成果**: 產出了一份權威性的架構規劃文件 (`planv2.md`)，為所有未來的開發工作提供了明確的指導和依據，確保團隊（包括 AI 代理）對系統的演進方向有統一的認識。

---
## 982號 - 2025-09-09T17:35:18.695428+08:00

### fix(core): 修復已完成任務未從處理佇列移除的問題

- **動機**: 使用者回報，前端的任務佇列有問題。當影片處理完成後，其狀態雖然更新為「已完成」，但項目並未從「處理中任務」列表移動到「已完成任務」列表，導致佇列項目殘留。
- **核心變更**:
    - **後端狀態標準化 (`src/api/api_server.py`)**:
        - **問題分析**: 經追查，後端在不同任務類型完成時，會回傳不一致的狀態值。例如，轉錄任務完成時回傳繁體中文的 `已完成`，而 AI 分析任務則回傳英文的 `completed`。
        - **程式碼修復**: 全面修改後端程式碼，將所有表示任務成功的最終狀態統一為標準化的英文關鍵字 `completed`。這消消除
